# 11. éŸ³é¢‘æ¸²æŸ“åŸºç¡€ï¼šPCM æ€ä¹ˆå˜æˆå£°éŸ³ï¼ˆä¸Šç¯‡ï¼šç†è®º + è§†è§‰åŒ–ï¼‰

> ä¸“æ å¯¼è¯»ï¼šæœ¬ç¯‡ç”¨ç›´è§‚æ¯”å–» + Mermaid æµç¨‹å›¾ + ä¸­è‹±åŒè¯­ AI æç¤ºè¯ç¤ºæ„å›¾ï¼Œå¸¦ä½ ä»â€œæ•°å­—çš„æ°´æ³¢ï¼ˆPCMï¼‰â€ä¸€è·¯èµ°åˆ°â€œè€³æœºé‡Œçš„å£°æ³¢â€ã€‚ä¸‹ä¸€ç¯‡å°†ç»“åˆ ZenPlay çš„ WASAPI è¾“å‡ºã€é‡é‡‡æ ·ä¸æ—¶é’ŸåŒæ­¥è¿›è¡Œå®è·µè®²è§£ã€‚

---

## ğŸ§ å¼€åœºï¼šæ•°å­—çš„æ°´æ³¢å¦‚ä½•æŠµè¾¾ä½ çš„è€³æœµ

æŠŠ PCM çœ‹ä½œè¢«å®šæ—¶é‡‡æ ·çš„â€œæ°´æ³¢é«˜åº¦â€åºåˆ—ï¼Œæ¯ä¸ªé‡‡æ ·æ—¶åˆ»è®°å½•å·¦/å³ä¸¤ä¸ªå£°é“çš„å¹…åº¦å€¼ã€‚æ’­æ”¾å™¨æŠŠè¿™äº›æ ·æœ¬æŒ‰èŠ‚æ‹é€åˆ°éŸ³é¢‘è®¾å¤‡ï¼Œè®¾å¤‡å†æŠŠå®ƒä»¬è¿˜åŸæˆè¿ç»­çš„ç”µå‹æ³¢å½¢é©±åŠ¨è€³æœºå‘å£°ã€‚

ğŸ“Š é…å›¾ Aï¼šæ•´ä½“å·¥è‰ºæµæ°´çº¿ï¼ˆAI æç¤ºè¯ï¼‰

- ä¸­æ–‡æç¤ºè¯ï¼š
  - ç™½è‰²èƒŒæ™¯ï¼Œ16:9 æ¨ªç‰ˆã€‚ä»å·¦åˆ°å³çš„å·¥è‰ºæµæ°´çº¿ï¼šæº PCMï¼ˆç£å¸¦å›¾æ ‡ï¼‰â†’ åº”ç”¨ç¼“å†²ï¼ˆå †å æ–¹å—ï¼‰â†’ è®¾å¤‡æ‹‰å–ï¼ˆé½¿è½®ï¼‰â†’ ç³»ç»Ÿæ··éŸ³å™¨ï¼ˆå‡è¡¡å™¨å›¾æ ‡ï¼‰â†’ DACï¼ˆèŠ¯ç‰‡ï¼‰â†’ è€³æœºï¼ˆè¾“å‡ºï¼‰ã€‚å„æ¨¡å—é¡¶éƒ¨ä»¥ä¸­è‹±æ–‡æ ‡æ³¨ï¼Œå¦‚â€œåº”ç”¨ç¼“å†² App Bufferâ€â€œç³»ç»Ÿæ··éŸ³ System Mixerâ€ã€‚è‰²å½©æŸ”å’Œã€çº¿æ¡ç®€æ´ã€‚
- English prompt:
  - White background, 16:9 landscape. Left-to-right pipeline: Source PCM (tape icon) â†’ App Buffer (stacked blocks) â†’ Device Pull (gear) â†’ System Mixer (equalizer icon) â†’ DAC (chip) â†’ Headphones (output). Bilingual labels on top of each block. Soft colors, clean lines.

---

## ğŸ”¢ PCM æ˜¯ä»€ä¹ˆï¼šæ ·æœ¬ã€å¸§ä¸æ•°æ®ç‡

- æ ·æœ¬ï¼ˆsampleï¼‰ï¼šå•ä¸ªå£°é“åœ¨æŸä¸€é‡‡æ ·æ—¶åˆ»çš„å¹…åº¦å€¼ï¼ˆå¦‚ 16-bit æ•´æ•°ï¼‰ã€‚
- å¸§ï¼ˆframeï¼‰ï¼šä¸€æ¬¡é‡‡æ ·çš„æ‰€æœ‰å£°é“æ ·æœ¬çš„é›†åˆï¼ˆç«‹ä½“å£°=2 ä¸ªæ ·æœ¬ï¼‰ã€‚
- æ•°æ®ç‡ï¼ˆBytes/sï¼‰= é‡‡æ ·ç‡ Ã— å£°é“æ•° Ã— æ¯æ ·æœ¬å­—èŠ‚æ•°ã€‚

ç¤ºä¾‹è®¡ç®—ï¼ˆ48 kHz / 16-bit / Stereoï¼‰ï¼š48000 Ã— 2 Ã— 2 = 192,000 Bytes/s â‰ˆ 187.5 KB/sã€‚

ğŸ“Š é…å›¾ Bï¼šå¸¸è§é‡‡æ ·é…ç½®ä¸æ•°æ®ç‡è¡¨ï¼ˆAI æç¤ºè¯ï¼‰

- ä¸­æ–‡æç¤ºè¯ï¼š
  - è¡¨æ ¼å›¾ï¼Œç™½è‰²èƒŒæ™¯ï¼Œ16:9 æ¨ªç‰ˆã€‚è¡¨å¤´ï¼šé‡‡æ ·ç‡ï¼ˆ44.1k/48k/96kï¼‰ã€ä½æ·±ï¼ˆ16/24ï¼‰ã€å£°é“ï¼ˆMono/Stereoï¼‰ã€Bytes/sã€KB/sã€‚å³ä¸‹è§’å°æ³¨ï¼šâ€œBytes/s = rate Ã— channels Ã— bytes_per_sampleâ€ã€‚
- English prompt:
  - Table chart, white background, 16:9 landscape. Headers: Sample Rate, Bit Depth, Channels, Bytes/s, KB/s. Bottom-right note: â€œBytes/s = rate Ã— channels Ã— bytes_per_sampleâ€.

---

## ğŸ›  æ’­æ”¾å™¨ä¸è®¾å¤‡ï¼šæ‹‰å–å¼å›è°ƒçš„èŠ‚æ‹

å¤šæ•°å¹³å°é‡‡ç”¨è®¾å¤‡æ‹‰å–ï¼ˆpullï¼‰ï¼šè®¾å¤‡æŒ‰ç…§å›ºå®šå‘¨æœŸä»ä½ çš„ç¼“å†²ä¸­å–èµ°ä¸€å°å— PCM å¸§ã€‚

```mermaid
sequenceDiagram
  participant App as åº”ç”¨å±‚ï¼ˆæ’­æ”¾å™¨ï¼‰
  participant Buf as ç¼“å†²é˜Ÿåˆ—ï¼ˆç¯å½¢ï¼‰
  participant Dev as éŸ³é¢‘è®¾å¤‡ï¼ˆWASAPI/CoreAudio/ALSAï¼‰
  App->>Buf: æŒç»­ç”Ÿäº§ PCM å¸§
  Dev->>Buf: æ¯ 10ms æ‹‰å– N å¸§
  Buf-->>Dev: äº¤ä»˜ä¸€å— PCMï¼ˆinterleaved LRLR...ï¼‰
  Dev->>Dev: ç³»ç»Ÿæ··éŸ³/æ ¼å¼é€‚é…
  Dev-->>User: å£°æ³¢è¾“å‡ºåˆ°è€³æœº
```

å‘¨æœŸä¼°ç®—ï¼šç¼“å†²å¸§æ•° / é‡‡æ ·ç‡ = å›è°ƒå‘¨æœŸï¼ˆç§’ï¼‰ã€‚ä¾‹å¦‚ç¼“å†² 480 å¸§ã€é‡‡æ ·ç‡ 48 kHz â†’ 10 ms/æ¬¡ã€‚

---

## â± å»¶è¿Ÿç”»åƒï¼šä»é˜Ÿåˆ—åˆ°è€³æœµçš„æ¯«ç§’è´¦å•

æ€»å»¶è¿Ÿ â‰ˆ åº”ç”¨ç«¯é˜Ÿåˆ— + è®¾å¤‡ç¼“å†² + ç³»ç»Ÿæ··éŸ³/DSPï¼ˆDAC/åŠŸæ”¾ç‰©ç†å»¶è¿Ÿé€šå¸¸å¯å¿½ç•¥ï¼‰ã€‚

```mermaid
flowchart LR
    A[åº”ç”¨é˜Ÿåˆ— App Queue] --> B[è®¾å¤‡ç¼“å†² Device Buffer]
    B --> C[ç³»ç»Ÿæ··éŸ³/å¤„ç† System Mixer/DSP]
    C --> D[DAC/AMP]
    D --> E[è€³æœº/æ‰¬å£°å™¨]
    subgraph ä¼°ç®— Estimate
    X[ç¼“å†²æ—¶å»¶(ms) = å¸§æ•°/é‡‡æ ·ç‡Ã—1000\nç¤ºä¾‹: 960/48k = 20ms]
    end
```

ğŸ“Š é…å›¾ Cï¼šå»¶è¿Ÿ vs ç¨³å®šæ€§æŠ˜ä¸­æ›²çº¿ï¼ˆAI æç¤ºè¯ï¼‰

- ä¸­æ–‡æç¤ºè¯ï¼š
  - æŠ˜çº¿å›¾ï¼Œç™½è‰²èƒŒæ™¯ï¼Œ16:9 æ¨ªç‰ˆã€‚X è½´â€œç¼“å†²å¤§å°ï¼ˆmsï¼‰â€ï¼Œä¸¤æ¡æ›²çº¿ï¼šå»¶è¿Ÿï¼ˆçº¢ï¼‰çº¿æ€§ä¸Šå‡ï¼›ç¨³å®šæ€§ï¼ˆè“ï¼‰éšç¼“å†²å¢å¤§è€Œè¶‹ç¨³ã€‚æ ‡æ³¨â€œä½å»¶è¿Ÿæ˜“æ–­éŸ³â€â€œå¤§ç¼“å†²åŒæ­¥æ›´éš¾â€ã€‚
- English prompt:
  - Line chart, white background, 16:9 landscape. X-axis â€œBuffer Size (ms)â€, curves: Latency (red, increasing), Stability (blue, saturating). Annotations â€œLow latency â†’ XRunsâ€, â€œLarge buffer â†’ Sync harderâ€.

---

## ğŸ” ä¸åŒæ ¼å¼å¦‚ä½•â€œåˆæ‹â€ï¼šé‡é‡‡æ ·ä¸é‡æ˜ å°„

å½“æºéŸ³é¢‘ä¸è®¾å¤‡é…ç½®ä¸ä¸€è‡´ï¼ˆé‡‡æ ·ç‡/ä½æ·±/é€šé“å¸ƒå±€ï¼‰ï¼Œéœ€è¦é‡é‡‡æ ·ï¼ˆResampleï¼‰ä¸é€šé“é‡æ˜ å°„ã€‚

```mermaid
flowchart LR
  S[æº PCM\n44.1kHz / S16 / Stereo] --> R{é‡é‡‡æ ·/é‡æ˜ å°„ Resample/Remap}
  R --> R1[é‡‡æ ·ç‡: 44.1k â†’ 48k]
  R --> R2[ä½æ·±/æ ¼å¼: S16 â†’ FLTP]
  R --> R3[é€šé“: 5.1 â†’ 2.0]
  R1 --> T[ç›®æ ‡ PCM â†’ è®¾å¤‡]
  R2 --> T
  R3 --> T
```

è®¾è®¡ç›®æ ‡ï¼šåœ¨å¯æ¥å—çš„å¼€é”€ä¸‹å°½é‡ä¿æŒé¢‘è°±å½¢çŠ¶ä¸ç›¸ä½ä¸€è‡´ï¼Œé¿å…å¯æ„ŸçŸ¥çš„å¤±çœŸã€‚

---

## ğŸ§­ æ—¶é’Ÿé€‰æ‹©ï¼šä¸ºä»€ä¹ˆâ€œéŸ³é¢‘ä¸»æ—¶é’Ÿâ€æ›´ç¨³

- éŸ³é¢‘è®¾å¤‡ç”±ç¡¬ä»¶æ—¶é’Ÿé©±åŠ¨ï¼ŒæŠ–åŠ¨ä½ã€å‘¨æœŸç¨³å®šã€‚
- æ’­æ”¾å™¨é€šå¸¸ä»¥â€œéŸ³é¢‘ä¸»æ—¶é’Ÿâ€ä¸ºåŸºå‡†ï¼Œè§†é¢‘å»è¿½éŸ³é¢‘ï¼ˆAUDIO_MASTERï¼‰ã€‚
- æ— éŸ³é¢‘æ—¶æ‰æ”¹ç”¨â€œè§†é¢‘ä¸»æ—¶é’Ÿâ€æˆ–å¤–éƒ¨ä¸»æ—¶é’Ÿã€‚

å›è°ƒèŠ‚æ‹æºäºè®¾å¤‡æ—¶é’Ÿ â†’ æ›´å®¹æ˜“å®ç°å¹³æ»‘ç¼“å†²ä¸æ—¶é—´çº¿ç®¡ç†ã€‚

---

## ğŸ¼ æœ€åä¸€å…¬é‡Œï¼šä»ç¦»æ•£åˆ°è¿ç»­çš„å£°æ³¢

å½“ PCM è¿›å…¥å£°å¡/è€³æ”¾ï¼šDAC å°†ç¦»æ•£å¹…åº¦å€¼è¿˜åŸä¸ºè¿ç»­ç”µå‹æ³¢å½¢ï¼Œä½é€šæ»¤æ³¢æŠ‘åˆ¶é‡‡æ ·å¸¦æ¥çš„é«˜é¢‘æˆåˆ†ï¼ŒåŠŸæ”¾æŠŠä¿¡å·æ”¾å¤§é©±åŠ¨è´Ÿè½½ï¼Œæœ€ç»ˆé¼“è†œæŒ¯åŠ¨å½¢æˆå¬æ„Ÿã€‚

ğŸ“Š é…å›¾ Dï¼šæ•°å­—â†’æ¨¡æ‹Ÿä¿¡å·é“¾ï¼ˆAI æç¤ºè¯ï¼‰

- ä¸­æ–‡æç¤ºè¯ï¼š
  - ä¿¡å·é“¾ç¤ºæ„å›¾ï¼Œç™½è‰²èƒŒæ™¯ï¼Œ16:9 æ¨ªç‰ˆã€‚æ¨¡å—ï¼šPCMï¼ˆç¦»æ•£ç‚¹ï¼‰â†’ DACï¼ˆèŠ¯ç‰‡æ–¹å—ï¼‰â†’ ä½é€šæ»¤æ³¢ï¼ˆåœ†è§’çŸ©å½¢ï¼‰â†’ åŠŸæ”¾ï¼ˆä¸‰è§’å½¢ï¼‰â†’ è€³æœºã€‚æ¯ä¸ªæ¨¡å—ä¸Šæ–¹ä¸­è‹±åŒæ ‡ï¼šâ€œDAC æ•°æ¨¡è½¬æ¢ / DACâ€â€œLPF ä½é€šæ»¤æ³¢ / Low-pass Filterâ€â€œAMP åŠŸæ”¾ / Amplifierâ€ã€‚
- English prompt:
  - Signal chain diagram, white background, 16:9 landscape. Modules: PCM (discrete dots) â†’ DAC (chip square) â†’ LPF (rounded rectangle) â†’ AMP (triangle) â†’ Headphones. Bilingual labels above each.

---

## ğŸ§ª ä¸€çœ¼çœ‹æ‡‚çš„æ­£å¼¦æ³¢ï¼šç”¨æ•°å­¦ç”Ÿæˆ PCM

æ ·æœ¬å€¼å…¬å¼ï¼š$s[n] = A\cdot\sin\left(2\pi f\frac{n}{F_s}\right)$ï¼Œå…¶ä¸­ $A$ ä¸ºå¹…åº¦ï¼Œ$f$ ä¸ºé¢‘ç‡ï¼Œ$F_s$ ä¸ºé‡‡æ ·ç‡ã€‚

ğŸ“Š é…å›¾ Eï¼šæ­£å¼¦æ³¢ä¸é‡‡æ ·ç‚¹ï¼ˆAI æç¤ºè¯ï¼‰

- ä¸­æ–‡æç¤ºè¯ï¼š
  - æ³¢å½¢å›¾ï¼Œç™½è‰²èƒŒæ™¯ï¼Œ16:9 æ¨ªç‰ˆã€‚è“è‰²è¿ç»­æ­£å¼¦æ›²çº¿ï¼Œä¸Šå å‡åŒ€é»‘ç‚¹é‡‡æ ·ï¼ˆæ¯å‘¨æœŸ 48 ç‚¹ä»£è¡¨ 48kHzï¼‰ã€‚å·¦ä¸Šè§’æ ‡æ³¨â€œf=440Hz, Fs=48kHz, A=0.8â€ã€‚
- English prompt:
  - Waveform diagram, white background, 16:9 landscape. Blue continuous sine curve with evenly spaced black sample dots (48 per cycle for 48kHz). Top-left label â€œf=440Hz, Fs=48kHz, A=0.8â€.

ç¤ºä¾‹ä»£ç ï¼ˆC++ï¼Œç”Ÿæˆ 1 ç§’ 48kHz/16-bit/stereo æ­£å¼¦æ³¢ï¼‰ï¼š

```cpp
#include <cmath>
#include <vector>
#include <cstdint>

struct PCMBuffer {
    std::vector<int16_t> interleaved; // LRLR...
    int sample_rate = 48000;
    int channels = 2;
};

PCMBuffer make_sine(double freq, double seconds, double amplitude = 0.8, int sample_rate = 48000) {
    PCMBuffer buf;
    buf.sample_rate = sample_rate;
    buf.channels = 2;
    int total_frames = static_cast<int>(seconds * sample_rate);
    buf.interleaved.resize(total_frames * buf.channels);

    for (int n = 0; n < total_frames; ++n) {
        double s = amplitude * std::sin(2.0 * M_PI * freq * n / sample_rate);
        int16_t v = static_cast<int16_t>(std::round(s * 32767));
        buf.interleaved[n * 2 + 0] = v; // L
        buf.interleaved[n * 2 + 1] = v; // R
    }
    return buf;
}
```

---

---

## ğŸ“š æœ¬ç¯‡æ€»ç»“ï¼ˆä¸‹ä¸€ç¯‡é¢„å‘Šï¼‰

- ä½ å·²æŒæ¡ï¼šPCM çš„ç»“æ„ä¸æ•°æ®ç‡ã€è®¾å¤‡æ‹‰å–æ—¶åºã€å»¶è¿Ÿæ„æˆä¸ä¼°ç®—ã€é‡é‡‡æ ·ä¸é‡æ˜ å°„ã€æ•°å­—åˆ°æ¨¡æ‹Ÿçš„ä¿¡å·é“¾ã€æ­£å¼¦æ³¢ç”Ÿæˆå®æ“ã€‚
- ä¸‹ä¸€ç¯‡ï¼ˆå®è·µç¯‡ï¼‰å°†è½åœ°åˆ° ZenPlayï¼šWASAPI æ‹‰å–å›è°ƒä¸ç¯å½¢ç¼“å†²ã€æºâ†’è®¾å¤‡çš„é‡é‡‡æ ·é€šé“ã€éŸ³é¢‘ä¸»æ—¶é’Ÿä¸ A/V åŒæ­¥ç­–ç•¥ã€ä¸æ¸²æŸ“çº¿ç¨‹/ç»Ÿè®¡ç³»ç»Ÿçš„åä½œã€‚

---

> ä½œè€…ï¼šZenPlay å›¢é˜Ÿ  
> æ›´æ–°æ—¶é—´ï¼š2025-01-27  
> ä¸“æ åœ°å€ï¼š[éŸ³è§†é¢‘å¼€å‘å…¥é—¨ä¸“æ ](../av_column_plan.md)  
> ä¸Šä¸€ç¯‡ï¼š[07. è§†é¢‘è§£ç å®æˆ˜ï¼šæŠŠ H.264 ç æµå˜æˆ YUVï¼ˆä¸Šç¯‡ï¼šç†è®º + å®è·µï¼‰](07_video_decode_theory_practice_v2.md)  
> ä¸‹ä¸€ç¯‡ï¼š11ï¼ˆä¸‹ï¼‰éŸ³é¢‘æ¸²æŸ“åŸºç¡€ï¼šZenPlay å®è·µç¯‡ï¼ˆWASAPI + é‡é‡‡æ · + åŒæ­¥ï¼‰
