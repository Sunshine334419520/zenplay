# å®Œæ•´çš„å¤šçº¿ç¨‹æ’­æ”¾å™¨æ¶æ„

## ğŸ¯ **æœ€ç»ˆæ¶æ„æ€»è§ˆ**

### çº¿ç¨‹åˆ†å·¥æ˜ç¡®
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Qtä¸»çº¿ç¨‹       â”‚  â”‚  Demuxçº¿ç¨‹       â”‚  â”‚  Decodeçº¿ç¨‹     â”‚  â”‚  Renderçº¿ç¨‹     â”‚
â”‚  (UIäº‹ä»¶)       â”‚  â”‚  (è§£å°è£…)        â”‚  â”‚  (è§£ç )         â”‚  â”‚  (æ¸²æŸ“å¾ªç¯)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·äº¤äº’        â”‚  â”‚ DemuxTask        â”‚  â”‚ VideoDecodeTask â”‚  â”‚ RenderTask      â”‚
â”‚ çª—å£äº‹ä»¶        â”‚  â”‚ æ•°æ®åŒ…åˆ†å‘       â”‚  â”‚ AudioDecodeTask â”‚  â”‚ 30fpså¾ªç¯       â”‚
â”‚ æ’­æ”¾æ§åˆ¶        â”‚  â”‚ é˜Ÿåˆ—ç®¡ç†         â”‚  â”‚ æ ¼å¼è½¬æ¢        â”‚  â”‚ SDLæ¸²æŸ“         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                          â”‚
                                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                              â”‚  Audioç³»ç»Ÿ      â”‚
                                                              â”‚  (ç‹¬ç«‹çº¿ç¨‹)     â”‚
                                                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                                              â”‚ AudioPlayer     â”‚
                                                              â”‚ WASAPI/ALSA     â”‚
                                                              â”‚ å®æ—¶æ’­æ”¾        â”‚
                                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå‘
```
Media File
    â†“ [Demux Thread]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Packet Queues   â”‚ (Video/Audioåˆ†ç¦»)
â”‚ (çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“               â†“
[Video Decode]  [Audio Decode]
    â†“               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Video Frames    â”‚ â”‚ Audio Frames    â”‚
â”‚ (æ¸²æŸ“é˜Ÿåˆ—)      â”‚ â”‚ (æ’­æ”¾é˜Ÿåˆ—)      â”‚ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“                       â†“
[Render Thread]         [AudioPlayer]
    â†“                       â†“
RendererProxy â”€â”€â”€â”€â†’ WASAPI/ALSA
    â†“                       â†“
loki UI Thread          Hardware Audio
    â†“
SDL Rendering
    â†“
Screen Display
```

## ğŸš€ **å…³é”®æ”¹è¿›**

### 1. **RenderTaskç°åœ¨æ˜¯ç‹¬ç«‹çº¿ç¨‹**
```cpp
// ä¹‹å‰ï¼šä½¿ç”¨lokiè°ƒåº¦ï¼Œå®¹æ˜“ä¸­æ–­
loki::LokiThread::PostTask(...);

// ç°åœ¨ï¼šç‹¬ç«‹çº¿ç¨‹æŒç»­è¿è¡Œ
render_thread_ = std::make_unique<std::thread>(&PlaybackController::RenderTask, this);
```

### 2. **éŸ³é¢‘å®Œå…¨ç‹¬ç«‹å¤„ç†**
```cpp
// AudioDecodeTask ç›´æ¥å‘é€ç»™ AudioPlayer
if (audio_decoder_->Decode(packet, &frames)) {
  for (auto& frame : frames) {
    if (audio_player_) {
      AVFramePtr audio_frame(av_frame_clone(frame.get()), ...);
      audio_player_->PushFrame(std::move(audio_frame));
    }
  }
}
```

### 3. **RendererProxyç¡®ä¿çº¿ç¨‹å®‰å…¨**
```cpp
// RenderTaskä¸­çš„è°ƒç”¨è‡ªåŠ¨å¤„ç†çº¿ç¨‹
renderer_->RenderFrame(video_frame.get());  // è‡ªåŠ¨æ´¾å‘åˆ°loki UIçº¿ç¨‹
renderer_->Present();                       // SDLè°ƒç”¨çº¿ç¨‹å®‰å…¨
```

## ğŸ”§ **éŸ³é¢‘ç³»ç»Ÿè¯¦è§£**

### Windows (WASAPI)
- **ä½å»¶è¿Ÿ**: ç›´æ¥è®¿é—®éŸ³é¢‘ç¡¬ä»¶
- **é«˜è´¨é‡**: æ”¯æŒç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼  
- **å®æ—¶æ’­æ”¾**: ä¸“é—¨çš„éŸ³é¢‘çº¿ç¨‹å¤„ç†
- **éŸ³é‡æ§åˆ¶**: é›†æˆç³»ç»ŸéŸ³é‡æ¥å£

### Linux (ALSA)  
- **å…¼å®¹æ€§å¥½**: æ”¯æŒå¤§éƒ¨åˆ†Linuxå‘è¡Œç‰ˆ
- **é…ç½®çµæ´»**: æ”¯æŒå¤šç§é‡‡æ ·ç‡å’Œæ ¼å¼
- **é”™è¯¯æ¢å¤**: å¤„ç†buffer underrunç­‰å¼‚å¸¸
- **æ··éŸ³æ”¯æŒ**: é›†æˆALSAæ··éŸ³å™¨æ§åˆ¶

### è·¨å¹³å°æŠ½è±¡
```cpp
// ç»Ÿä¸€æ¥å£ï¼Œå¹³å°é€æ˜
auto audio_output = AudioOutput::Create();  // è‡ªåŠ¨é€‰æ‹©å¹³å°å®ç°
audio_output->Init(spec, callback, user_data);
audio_output->Start();
```

## ğŸ“Š **æ€§èƒ½ç‰¹å¾**

### å†…å­˜ä½¿ç”¨
- **Video Queue**: æœ€å¤§30å¸§ (~200MB for 1080p)
- **Audio Queue**: æœ€å¤§50å¸§ (~5MB for 44kHz stereo)
- **Audio Buffer**: 4xå†…éƒ¨ç¼“å†²é˜²æ­¢underrun
- **Resampling**: æŒ‰éœ€åˆ†é…ï¼Œè‡ªåŠ¨é‡Šæ”¾

### CPUè´Ÿè½½åˆ†å¸ƒ
```
Demux Thread     â–“â–‘â–‘â–‘â–‘ ~5%  (I/Oå¯†é›†)
Video Decode     â–“â–“â–“â–“â–“ ~30% (CPUå¯†é›†) 
Audio Decode     â–“â–“â–‘â–‘â–‘ ~10% (è½»é‡çº§)
Render Thread    â–“â–“â–‘â–‘â–‘ ~8%  (GPUäº¤äº’)
Audio Thread     â–“â–‘â–‘â–‘â–‘ ~3%  (å®æ—¶è¦æ±‚)
```

### å»¶è¿Ÿç‰¹æ€§
- **è§†é¢‘å»¶è¿Ÿ**: ~100ms (3-4å¸§ç¼“å†²)
- **éŸ³é¢‘å»¶è¿Ÿ**: ~20ms (WASAPIä½å»¶è¿Ÿ)
- **åŒæ­¥ç²¾åº¦**: å¸§çº§åˆ«åŒæ­¥

## ğŸ® **å®é™…ä½¿ç”¨åœºæ™¯**

### åŸºæœ¬æ’­æ”¾æµç¨‹
```cpp
// 1. åˆ›å»ºæ’­æ”¾å™¨
VideoPlayer player;

// 2. æ‰“å¼€æ–‡ä»¶
player.Open("movie.mp4");

// 3. è®¾ç½®æ¸²æŸ“çª—å£ (Qtä¸»çº¿ç¨‹ â†’ loki UIçº¿ç¨‹)
HWND hwnd = GetWindowHandle();
player.SetRenderWindow(hwnd, 1920, 1080);

// 4. å¼€å§‹æ’­æ”¾ (å¯åŠ¨æ‰€æœ‰çº¿ç¨‹)
player.Play();
/*
å¯åŠ¨é¡ºåºï¼š
- DemuxTask (std::thread)
- VideoDecodeTask (std::thread) 
- AudioDecodeTask (std::thread)
- RenderTask (std::thread)
- AudioPlayer (å†…éƒ¨audioçº¿ç¨‹)
*/
```

### æ§åˆ¶æ“ä½œ
```cpp
// æ‰€æœ‰æ“ä½œéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„
player.Pause();   // æš‚åœæ‰€æœ‰çº¿ç¨‹å’ŒéŸ³é¢‘è¾“å‡º
player.Resume();  // æ¢å¤æ‰€æœ‰çº¿ç¨‹å’ŒéŸ³é¢‘è¾“å‡º
player.Stop();    // ä¼˜é›…åœæ­¢æ‰€æœ‰çº¿ç¨‹
player.SetVolume(0.8f);  // å®æ—¶éŸ³é‡è°ƒèŠ‚
```

### é”™è¯¯å¤„ç†
```cpp
// éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥
if (!audio_player_->Init()) {
  std::cerr << "Audio disabled, video-only playback\n";
  // æ’­æ”¾å™¨ä»ç„¶å¯ä»¥æ­£å¸¸æ’­æ”¾è§†é¢‘
}

// æ¸²æŸ“å™¨åˆå§‹åŒ–å¤±è´¥  
if (!renderer_->Init(hwnd, width, height)) {
  std::cerr << "Video rendering failed\n";
  // å¯ä»¥ç»§ç»­éŸ³é¢‘æ’­æ”¾
}
```

## âœ… **æ¶æ„ä¼˜åŠ¿æ€»ç»“**

### ğŸ”„ **çº¿ç¨‹èŒè´£æ¸…æ™°**
- æ¯ä¸ªçº¿ç¨‹ä¸“æ³¨å•ä¸€ä»»åŠ¡
- é¿å…çº¿ç¨‹é—´ç«äº‰å’Œé˜»å¡
- ä¾¿äºè°ƒè¯•å’Œæ€§èƒ½è°ƒä¼˜

### ğŸ”’ **çº¿ç¨‹å®‰å…¨ä¿è¯**  
- æ‰€æœ‰é˜Ÿåˆ—ä½¿ç”¨çº¿ç¨‹å®‰å…¨å®ç°
- RendererProxyå¤„ç†SDLçº¿ç¨‹é—®é¢˜
- åŸå­æ“ä½œç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§

### ğŸ¯ **å®æ—¶æ€§èƒ½å¥½**
- éŸ³é¢‘ç‹¬ç«‹çº¿ç¨‹ï¼Œå»¶è¿Ÿç¨³å®š
- è§†é¢‘æ¸²æŸ“å¾ªç¯ï¼Œå¸§ç‡ç¨³å®š  
- è§£ç å’Œæ¸²æŸ“åˆ†ç¦»ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸

### ğŸ”§ **æ˜“äºæ‰©å±•**
- å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„è§£ç å™¨
- æ”¯æŒæ›´å¤šéŸ³é¢‘è¾“å‡ºåç«¯
- æ¸²æŸ“å™¨å¯ä»¥åˆ‡æ¢ä¸åŒå®ç°

### ğŸ› **è°ƒè¯•å‹å¥½**
- æ¯ä¸ªçº¿ç¨‹å¯ä»¥ç‹¬ç«‹ç›‘æ§
- é˜Ÿåˆ—çŠ¶æ€å¯ä»¥å®æ—¶æŸ¥çœ‹
- é”™è¯¯éš”ç¦»ï¼Œä¸ä¼šå½±å“å…¶ä»–ç»„ä»¶

**è¿™ä¸ªæ¶æ„ç°åœ¨å®Œå…¨è§£å†³äº†ä¹‹å‰çš„é—®é¢˜ï¼Œå®ç°äº†çœŸæ­£çš„å¤šåª’ä½“æ’­æ”¾å™¨ï¼** ğŸ‰
