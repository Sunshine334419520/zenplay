# ğŸ¬ ZenPlayer::Open() AndThen æ‰§è¡Œæµç¨‹æ¨¡æ‹Ÿ

## ğŸ“‹ é‡æ„å‰åå¯¹æ¯”

### âŒ é‡æ„å‰ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰
```cpp
bool ZenPlayer::Open(const std::string& url) {
  auto demux_result = demuxer_->Open(url);
  if (!demux_result.IsOk()) {
    MODULE_ERROR(...);
    return false;  // å¿˜è®°æ¸…ç†ï¼Ÿ
  }

  if (video_stream) {
    auto video_result = video_decoder_->Open(...);
    if (!video_result.IsOk()) {
      demuxer_->Close();  // âŒ æ‰‹åŠ¨æ¸…ç†ï¼ˆå®¹æ˜“é—æ¼ï¼‰
      MODULE_ERROR(...);
      return false;
    }
  }

  if (audio_stream) {
    auto audio_result = audio_decoder_->Open(...);
    if (!audio_result.IsOk()) {
      video_decoder_->Close();  // âŒ å¿…é¡»è®°ä½å‰é¢çš„èµ„æº
      demuxer_->Close();
      MODULE_ERROR(...);
      return false;
    }
  }
  
  // ... åˆ›å»ºæ’­æ”¾æ§åˆ¶å™¨
  return true;
}
```

**é—®é¢˜**ï¼š
1. ğŸ› **æ˜“å‡ºé”™**ï¼šæ¯ä¸ªé”™è¯¯è·¯å¾„éƒ½è¦æ‰‹åŠ¨æ¸…ç†ï¼Œå®¹æ˜“é—æ¼
2. ğŸ“š **éš¾ç»´æŠ¤**ï¼šæ–°å¢æ­¥éª¤éœ€è¦æ›´æ–°æ‰€æœ‰é”™è¯¯è·¯å¾„
3. ğŸ” **é‡å¤ä»£ç **ï¼šç›¸ä¼¼çš„é”™è¯¯å¤„ç†é€»è¾‘é‡å¤å¤šæ¬¡
4. ğŸ“– **å¯è¯»æ€§å·®**ï¼šæ·±å±‚åµŒå¥—ï¼Œéš¾ä»¥ç†è§£æµç¨‹

---

### âœ… é‡æ„åï¼ˆAndThen é“¾å¼è°ƒç”¨ï¼‰
```cpp
Result<void> ZenPlayer::Open(const std::string& url) {
  return demuxer_->Open(url)
      .AndThen([this](auto) { return video_decoder_->Open(...); })
      .AndThen([this](auto) { return audio_decoder_->Open(...); })
      .AndThen([this](auto) { /* åˆ›å»ºæ§åˆ¶å™¨ */ return Result<void>::Ok(); })
      .MapErr([this](ErrorCode code) { 
        /* ç»Ÿä¸€æ¸…ç† */ 
        Cleanup(); 
        return code; 
      });
}
```

**ä¼˜åŠ¿**ï¼š
1. âœ… **å®‰å…¨**ï¼šç»Ÿä¸€çš„æ¸…ç†è·¯å¾„ï¼Œä¸ä¼šé—æ¼
2. âœ… **æ˜“ç»´æŠ¤**ï¼šæ–°å¢æ­¥éª¤åªéœ€æ·»åŠ ä¸€ä¸ª `.AndThen()`
3. âœ… **ç®€æ´**ï¼šæ¶ˆé™¤é‡å¤çš„é”™è¯¯å¤„ç†ä»£ç 
4. âœ… **å¯è¯»**ï¼šçº¿æ€§æµç¨‹ï¼Œä¸€ç›®äº†ç„¶

---

## ğŸ¯ MapErr è¯¦è§£

### MapErr çš„æœ¬è´¨

```cpp
template <typename F>
Result<T> MapErr(F&& f) {
  if (IsOk()) {
    return std::move(*this);  // âœ… æˆåŠŸæ—¶ï¼šåŸæ ·è¿”å›
  }
  // âŒ å¤±è´¥æ—¶ï¼šåº”ç”¨å‡½æ•°åˆ°é”™è¯¯ç 
  return Result<T>::Err(std::forward<F>(f)(error_code_), message_);
}
```

### MapErr çš„ä¸¤ç§ç”¨æ³•

#### ç”¨æ³• 1ï¼šè½¬æ¢é”™è¯¯ç 
```cpp
.MapErr([](ErrorCode e) {
  // å°†æ‰€æœ‰åº•å±‚é”™è¯¯ç»Ÿä¸€æ˜ å°„ä¸ºé«˜å±‚é”™è¯¯
  if (e == ErrorCode::kFileNotFound || e == ErrorCode::kIOError) {
    return ErrorCode::kDemuxError;  // ç»Ÿä¸€ä¸ºè§£å°è£…é”™è¯¯
  }
  return e;
});
```

#### ç”¨æ³• 2ï¼šæ‰§è¡Œæ¸…ç†å‰¯ä½œç”¨ï¼ˆæœ¬é¡¹ç›®ä½¿ç”¨ï¼‰
```cpp
.MapErr([this, &url](ErrorCode code) {
  // ğŸ§¹ å‰¯ä½œç”¨ï¼šæ¸…ç†èµ„æº
  Cleanup();
  
  // ğŸ“ å‰¯ä½œç”¨ï¼šè®°å½•æ—¥å¿—
  MODULE_ERROR(LOG_MODULE_PLAYER, "Failed to open '{}'", url);
  
  // ğŸ”„ å‰¯ä½œç”¨ï¼šçŠ¶æ€è½¬æ¢
  state_manager_->TransitionToError();
  
  // è¿”å›åŸé”™è¯¯ç ï¼ˆä¸è½¬æ¢ï¼‰
  return code;
});
```

**å…³é”®ç‚¹**ï¼š
- `MapErr` çš„ lambda **å¿…é¡»è¿”å›ä¸€ä¸ª ErrorCode**
- è¿”å›çš„ ErrorCode ä¼šæˆä¸ºæ–°çš„é”™è¯¯ç 
- **å‰¯ä½œç”¨**ï¼ˆå¦‚æ¸…ç†èµ„æºã€è®°å½•æ—¥å¿—ï¼‰åœ¨ lambda å†…éƒ¨æ‰§è¡Œ
- å¦‚æœä¸éœ€è¦è½¬æ¢é”™è¯¯ç ï¼Œç›´æ¥ `return code;`

---

## ğŸ¬ æ‰§è¡Œæµç¨‹æ¨¡æ‹Ÿ

å‡è®¾æ‰“å¼€æ–‡ä»¶ `test.mp4`ï¼š

### åœºæ™¯ 1ï¼šâœ… æ‰€æœ‰æ­¥éª¤æˆåŠŸ

```
ç”¨æˆ·è°ƒç”¨ï¼šplayer->Open("test.mp4")

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 0: å‡†å¤‡é˜¶æ®µ                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ—¥å¿—ï¼šOpening URL: test.mp4                                â”‚
â”‚ â€¢ æ£€æŸ¥ï¼šis_opened_ = falseï¼ˆæœªæ‰“å¼€ï¼‰                          â”‚
â”‚ â€¢ çŠ¶æ€ï¼šTransitionToOpening()                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: demuxer_->Open(url)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ FFmpeg avformat_open_input() æˆåŠŸ                          â”‚
â”‚ â€¢ FFmpeg avformat_find_stream_info() æˆåŠŸ                    â”‚
â”‚ â€¢ è¿”å›ï¼šResult<void>::Ok()                                   â”‚
â”‚                                                              â”‚
â”‚ âœ… IsOk() = true â†’ ç»§ç»­æ‰§è¡Œ .AndThen()                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: .AndThen(æ‰“å¼€è§†é¢‘è§£ç å™¨)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æŸ¥æ‰¾è§†é¢‘æµï¼šactive_video_stream_index = 0ï¼ˆæ‰¾åˆ°ï¼‰          â”‚
â”‚ â€¢ æ—¥å¿—ï¼šOpening video decoder...                             â”‚
â”‚ â€¢ video_decoder_->Open(codecpar)                            â”‚
â”‚   - avcodec_find_decoder() æˆåŠŸ                             â”‚
â”‚   - avcodec_open2() æˆåŠŸ                                    â”‚
â”‚ â€¢ è¿”å›ï¼šResult<void>::Ok()                                   â”‚
â”‚                                                              â”‚
â”‚ âœ… IsOk() = true â†’ ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ª .AndThen()                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: .AndThen(æ‰“å¼€éŸ³é¢‘è§£ç å™¨)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æŸ¥æ‰¾éŸ³é¢‘æµï¼šactive_audio_stream_index = 1ï¼ˆæ‰¾åˆ°ï¼‰          â”‚
â”‚ â€¢ æ—¥å¿—ï¼šOpening audio decoder...                             â”‚
â”‚ â€¢ audio_decoder_->Open(codecpar)                            â”‚
â”‚   - avcodec_find_decoder() æˆåŠŸ                             â”‚
â”‚   - avcodec_open2() æˆåŠŸ                                    â”‚
â”‚ â€¢ è¿”å›ï¼šResult<void>::Ok()                                   â”‚
â”‚                                                              â”‚
â”‚ âœ… IsOk() = true â†’ ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ª .AndThen()                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: .AndThen(åˆ›å»ºæ’­æ”¾æ§åˆ¶å™¨)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ—¥å¿—ï¼šCreating playback controller...                      â”‚
â”‚ â€¢ playback_controller_ = new PlaybackController(...)        â”‚
â”‚ â€¢ is_opened_ = true                                         â”‚
â”‚ â€¢ çŠ¶æ€ï¼šTransitionToStopped()                                â”‚
â”‚ â€¢ æ—¥å¿—ï¼šâœ… File opened successfully, state: Stopped          â”‚
â”‚ â€¢ è¿”å›ï¼šResult<void>::Ok()                                   â”‚
â”‚                                                              â”‚
â”‚ âœ… IsOk() = true â†’ è·³è¿‡ .MapErr()                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ€ç»ˆç»“æœï¼šResult<void>::Ok()                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è¿”å›ç»™è°ƒç”¨è€…ï¼šSuccess                                       â”‚
â”‚ â€¢ UI å¯ä»¥è°ƒç”¨ Play() å¼€å§‹æ’­æ”¾                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### åœºæ™¯ 2ï¼šâŒ Step 1 å¤±è´¥ï¼ˆæ–‡ä»¶ä¸å­˜åœ¨ï¼‰

```
ç”¨æˆ·è°ƒç”¨ï¼šplayer->Open("nonexistent.mp4")

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 0: å‡†å¤‡é˜¶æ®µ                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ—¥å¿—ï¼šOpening URL: nonexistent.mp4                         â”‚
â”‚ â€¢ çŠ¶æ€ï¼šTransitionToOpening()                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: demuxer_->Open(url)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ FFmpeg avformat_open_input() å¤±è´¥ï¼šAVERROR(ENOENT)        â”‚
â”‚ â€¢ è¿”å›ï¼šResult<void>::Err(                                   â”‚
â”‚     ErrorCode::kFileNotFound,                               â”‚
â”‚     "Failed to open input: No such file")                   â”‚
â”‚                                                              â”‚
â”‚ âŒ IsOk() = false â†’ è·³è¿‡æ‰€æœ‰ .AndThen()ï¼Œç›´æ¥æ‰§è¡Œ .MapErr() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ (è·³è¿‡ Step 2, 3, 4)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é”™è¯¯å¤„ç†ï¼š.MapErr()                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ¥æ”¶åˆ°é”™è¯¯ç ï¼šErrorCode::kFileNotFound                     â”‚
â”‚                                                              â”‚
â”‚ â€¢ ğŸ§¹ æ¸…ç†èµ„æºï¼š                                              â”‚
â”‚   - playback_controller_.reset() (ç©ºï¼Œè·³è¿‡)                  â”‚
â”‚   - audio_decoder_->Close() (æœªæ‰“å¼€ï¼Œè·³è¿‡)                   â”‚
â”‚   - video_decoder_->Close() (æœªæ‰“å¼€ï¼Œè·³è¿‡)                   â”‚
â”‚   - demuxer_->Close() (æœªå®Œå…¨æ‰“å¼€ï¼Œè·³è¿‡)                     â”‚
â”‚                                                              â”‚
â”‚ â€¢ ğŸ“ è®°å½•æ—¥å¿—ï¼š                                              â”‚
â”‚   MODULE_ERROR(LOG_MODULE_PLAYER,                           â”‚
â”‚     "âŒ Failed to open 'nonexistent.mp4': FileNotFound")    â”‚
â”‚                                                              â”‚
â”‚ â€¢ ğŸ”„ çŠ¶æ€è½¬æ¢ï¼š                                              â”‚
â”‚   state_manager_->TransitionToError()                       â”‚
â”‚                                                              â”‚
â”‚ â€¢ is_opened_ = false                                        â”‚
â”‚                                                              â”‚
â”‚ â€¢ è¿”å›ï¼šErrorCode::kFileNotFound (ä¿æŒä¸å˜)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ€ç»ˆç»“æœï¼šResult<void>::Err(                                 â”‚
â”‚   ErrorCode::kFileNotFound,                                 â”‚
â”‚   "Failed to open input: No such file"                      â”‚
â”‚ )                                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ UI ä»£ç æ£€æµ‹ï¼šresult.IsOk() = false                         â”‚
â”‚ â€¢ UI æ˜¾ç¤ºé”™è¯¯ï¼š                                              â”‚
â”‚   QMessageBox::critical("Error", result.Error().message)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### åœºæ™¯ 3ï¼šâŒ Step 2 å¤±è´¥ï¼ˆè§†é¢‘è§£ç å™¨æ‰“å¼€å¤±è´¥ï¼‰

```
ç”¨æˆ·è°ƒç”¨ï¼šplayer->Open("corrupted.mp4")

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 0: å‡†å¤‡é˜¶æ®µ                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: demuxer_->Open(url) âœ…                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ–‡ä»¶æ‰“å¼€æˆåŠŸï¼Œæµä¿¡æ¯è¯»å–æˆåŠŸ                                â”‚
â”‚ â€¢ è¿”å›ï¼šResult<void>::Ok()                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: .AndThen(æ‰“å¼€è§†é¢‘è§£ç å™¨) âŒ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æŸ¥æ‰¾è§†é¢‘æµï¼šæ‰¾åˆ°ï¼ˆindex = 0ï¼‰                               â”‚
â”‚ â€¢ æ—¥å¿—ï¼šOpening video decoder...                             â”‚
â”‚ â€¢ video_decoder_->Open(codecpar)                            â”‚
â”‚   - avcodec_find_decoder() æˆåŠŸ                             â”‚
â”‚   - avcodec_open2() å¤±è´¥ï¼šAVERROR(EINVAL) [å‚æ•°æŸå]        â”‚
â”‚ â€¢ è¿”å›ï¼šResult<void>::Err(                                   â”‚
â”‚     ErrorCode::kDecoderInitFailed,                          â”‚
â”‚     "Failed to open codec: Invalid data")                   â”‚
â”‚                                                              â”‚
â”‚ âŒ IsOk() = false â†’ è·³è¿‡åç»­ .AndThen()ï¼Œæ‰§è¡Œ .MapErr()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ (è·³è¿‡ Step 3, 4)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é”™è¯¯å¤„ç†ï¼š.MapErr()                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ¥æ”¶åˆ°é”™è¯¯ç ï¼šErrorCode::kDecoderInitFailed                â”‚
â”‚                                                              â”‚
â”‚ â€¢ ğŸ§¹ æ¸…ç†èµ„æºï¼š                                              â”‚
â”‚   - playback_controller_.reset() (æœªåˆ›å»ºï¼Œè·³è¿‡)              â”‚
â”‚   - audio_decoder_->Close() (æœªæ‰“å¼€ï¼Œè·³è¿‡)                   â”‚
â”‚   - video_decoder_->Close() (æ‰“å¼€å¤±è´¥ï¼Œè·³è¿‡)                 â”‚
â”‚   - demuxer_->Close() âœ… (å·²æ‰“å¼€ï¼Œéœ€è¦å…³é—­ï¼)                â”‚
â”‚                                                              â”‚
â”‚ â€¢ ğŸ“ è®°å½•æ—¥å¿—ï¼š                                              â”‚
â”‚   MODULE_ERROR(LOG_MODULE_PLAYER,                           â”‚
â”‚     "âŒ Failed to open 'corrupted.mp4': DecoderInitFailed") â”‚
â”‚                                                              â”‚
â”‚ â€¢ ğŸ”„ çŠ¶æ€è½¬æ¢ï¼šTransitionToError()                           â”‚
â”‚ â€¢ is_opened_ = false                                        â”‚
â”‚ â€¢ è¿”å›ï¼šErrorCode::kDecoderInitFailed                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ€ç»ˆç»“æœï¼šResult<void>::Err(                                 â”‚
â”‚   ErrorCode::kDecoderInitFailed,                            â”‚
â”‚   "Failed to open codec: Invalid data"                      â”‚
â”‚ )                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®è§‚å¯Ÿ**ï¼š
- âœ… `demuxer_->Close()` è¢«è‡ªåŠ¨è°ƒç”¨ï¼ˆMapErr ç»Ÿä¸€æ¸…ç†ï¼‰
- âœ… æ— éœ€åœ¨æ¯ä¸ª `.AndThen()` å†…éƒ¨æ‰‹åŠ¨æ¸…ç†å‰é¢çš„èµ„æº
- âœ… ä»£ç æ›´ç®€æ´ï¼Œä¸ä¼šé—æ¼æ¸…ç†é€»è¾‘

---

### åœºæ™¯ 4ï¼šâŒ Step 3 å¤±è´¥ï¼ˆéŸ³é¢‘è§£ç å™¨æ‰“å¼€å¤±è´¥ï¼‰

```
ç”¨æˆ·è°ƒç”¨ï¼šplayer->Open("video_only_bad_audio.mp4")

Step 1: demuxer_->Open(url) âœ… æˆåŠŸ
Step 2: video_decoder_->Open() âœ… æˆåŠŸ
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: .AndThen(æ‰“å¼€éŸ³é¢‘è§£ç å™¨) âŒ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æŸ¥æ‰¾éŸ³é¢‘æµï¼šæ‰¾åˆ°ï¼ˆindex = 1ï¼‰                               â”‚
â”‚ â€¢ audio_decoder_->Open(codecpar) å¤±è´¥                        â”‚
â”‚ â€¢ è¿”å›ï¼šResult<void>::Err(                                   â”‚
â”‚     ErrorCode::kUnsupportedCodec,                           â”‚
â”‚     "Codec not supported")                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ (è·³è¿‡ Step 4)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é”™è¯¯å¤„ç†ï¼š.MapErr()                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ğŸ§¹ æ¸…ç†èµ„æºï¼š                                              â”‚
â”‚   - playback_controller_.reset() (æœªåˆ›å»º)                    â”‚
â”‚   - audio_decoder_->Close() (æ‰“å¼€å¤±è´¥ï¼Œè·³è¿‡)                 â”‚
â”‚   - video_decoder_->Close() âœ… (å·²æ‰“å¼€ï¼Œéœ€è¦å…³é—­ï¼)          â”‚
â”‚   - demuxer_->Close() âœ… (å·²æ‰“å¼€ï¼Œéœ€è¦å…³é—­ï¼)                â”‚
â”‚                                                              â”‚
â”‚ â€¢ ğŸ“ æ—¥å¿—ï¼šFailed to open: UnsupportedCodec                  â”‚
â”‚ â€¢ ğŸ”„ çŠ¶æ€ï¼šTransitionToError()                               â”‚
â”‚ â€¢ è¿”å›ï¼šErrorCode::kUnsupportedCodec                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®è§‚å¯Ÿ**ï¼š
- âœ… å·²æˆåŠŸæ‰“å¼€çš„ `demuxer_` å’Œ `video_decoder_` è¢«è‡ªåŠ¨å…³é—­
- âœ… æ— éœ€åœ¨ Step 3 çš„ lambda å†…éƒ¨æ‰‹åŠ¨æ¸…ç† Step 1 å’Œ Step 2 çš„èµ„æº

---

## ğŸ” AndThen vs ä¼ ç»Ÿæ–¹å¼çš„èµ„æºæ¸…ç†å¯¹æ¯”

### ä¼ ç»Ÿæ–¹å¼çš„æ¸…ç†çŸ©é˜µ

| å¤±è´¥ä½ç½® | éœ€è¦æ¸…ç†çš„èµ„æº | ä»£ç ä½ç½® |
|---------|---------------|---------|
| Step 1 å¤±è´¥ | æ—  | `if (!demux_result.IsOk())` å†… |
| Step 2 å¤±è´¥ | demuxer | `if (!video_result.IsOk())` å†… |
| Step 3 å¤±è´¥ | demuxer + video_decoder | `if (!audio_result.IsOk())` å†… |
| Step 4 å¤±è´¥ | å…¨éƒ¨ | `if (!controller_created)` å†… |

**é—®é¢˜**ï¼šæ¯ä¸ªé”™è¯¯è·¯å¾„éƒ½è¦**æ‰‹åŠ¨æšä¸¾**å‰é¢çš„èµ„æºï¼Œææ˜“å‡ºé”™ï¼

---

### AndThen æ–¹å¼çš„æ¸…ç†çŸ©é˜µ

| å¤±è´¥ä½ç½® | æ¸…ç†é€»è¾‘ | ä»£ç ä½ç½® |
|---------|---------|---------|
| ä»»ä½•æ­¥éª¤å¤±è´¥ | å…¨éƒ¨èµ„æºï¼ˆå¸¦æ¡ä»¶æ£€æŸ¥ï¼‰ | **ç»Ÿä¸€åœ¨ `.MapErr()` å†…** |

**ä¼˜åŠ¿**ï¼š
- âœ… **å•ä¸€è´£ä»»**ï¼šæ¸…ç†é€»è¾‘åªåœ¨ä¸€ä¸ªåœ°æ–¹
- âœ… **é˜²å¾¡æ€§ç¼–ç¨‹**ï¼š`if (resource && resource->opened())`
- âœ… **æ˜“ç»´æŠ¤**ï¼šæ–°å¢æ­¥éª¤æ— éœ€ä¿®æ”¹æ¸…ç†é€»è¾‘

---

## ğŸ“Š ä»£ç è¡Œæ•°å¯¹æ¯”

### ä¼ ç»Ÿæ–¹å¼
```cpp
bool Open(const std::string& url) {
  // ... å‡†å¤‡ ...
  
  auto demux_result = demuxer_->Open(url);
  if (!demux_result.IsOk()) {
    MODULE_ERROR(...);        // 3 è¡Œ
    return false;             // 1 è¡Œ
  }                           // å…± 5 è¡Œ
  
  if (video_stream) {
    auto video_result = video_decoder_->Open(...);
    if (!video_result.IsOk()) {
      demuxer_->Close();      // 1 è¡Œ
      MODULE_ERROR(...);      // 3 è¡Œ
      return false;           // 1 è¡Œ
    }                         // å…± 7 è¡Œ
  }
  
  if (audio_stream) {
    auto audio_result = audio_decoder_->Open(...);
    if (!audio_result.IsOk()) {
      video_decoder_->Close();// 1 è¡Œ
      demuxer_->Close();      // 1 è¡Œ
      MODULE_ERROR(...);      // 3 è¡Œ
      return false;           // 1 è¡Œ
    }                         // å…± 8 è¡Œ
  }
  
  // ... åˆ›å»ºæ§åˆ¶å™¨ ...
  return true;
}

// æ€»è®¡ï¼šçº¦ 70 è¡Œï¼ˆåŒ…æ‹¬æ³¨é‡Šå’Œç©ºè¡Œï¼‰
```

---

### AndThen æ–¹å¼
```cpp
Result<void> Open(const std::string& url) {
  // ... å‡†å¤‡ ...
  
  return demuxer_->Open(url)
      .AndThen([this](auto) { /* æ‰“å¼€è§†é¢‘ */ })   // 5 è¡Œ
      .AndThen([this](auto) { /* æ‰“å¼€éŸ³é¢‘ */ })   // 5 è¡Œ
      .AndThen([this](auto) { /* åˆ›å»ºæ§åˆ¶å™¨ */ }) // 7 è¡Œ
      .MapErr([this](ErrorCode code) {            // 15 è¡Œï¼ˆç»Ÿä¸€æ¸…ç†ï¼‰
        /* æ¸…ç†æ‰€æœ‰èµ„æº */
        return code;
      });
}

// æ€»è®¡ï¼šçº¦ 50 è¡Œï¼ˆå‡å°‘ 30%ï¼‰
```

---

## ğŸ“ å…³é”®æ”¶ç›Šæ€»ç»“

| ç»´åº¦ | ä¼ ç»Ÿæ–¹å¼ | AndThen æ–¹å¼ |
|-----|---------|-------------|
| **ä»£ç è¡Œæ•°** | 70 è¡Œ | 50 è¡Œ (-30%) |
| **é”™è¯¯å¤„ç†ç‚¹** | 3 ä¸ªç‹¬ç«‹çš„ if | 1 ä¸ªç»Ÿä¸€çš„ MapErr |
| **æ¸…ç†é€»è¾‘** | åˆ†æ•£åœ¨ 3 å¤„ | é›†ä¸­åœ¨ 1 å¤„ |
| **æ¼æ‰æ¸…ç†çš„é£é™©** | âš ï¸ é«˜ | âœ… ä½ |
| **æ–°å¢æ­¥éª¤æˆæœ¬** | éœ€æ›´æ–°æ‰€æœ‰é”™è¯¯è·¯å¾„ | åªéœ€åŠ ä¸€ä¸ª `.AndThen()` |
| **å¯è¯»æ€§** | åµŒå¥—æ·± | çº¿æ€§æµç¨‹ |
| **ç»´æŠ¤æ€§** | å›°éš¾ | ç®€å• |

---

## ğŸš€ å®é™…ä½¿ç”¨å»ºè®®

### é€‚åˆä½¿ç”¨ AndThen çš„åœºæ™¯

1. âœ… **å¤šæ­¥éª¤åˆå§‹åŒ–**ï¼šOpen, Init, Connect
2. âœ… **èµ„æºç”³è¯·é“¾**ï¼šæ‰“å¼€æ–‡ä»¶ â†’ åˆ†é…å†…å­˜ â†’ åˆ›å»ºå¯¹è±¡
3. âœ… **çŠ¶æ€è½¬æ¢é“¾**ï¼šéªŒè¯ â†’ è§£æ â†’ æ‰§è¡Œ
4. âœ… **æ•°æ®å¤„ç†ç®¡é“**ï¼šè¯»å– â†’ è§£ç  â†’ è½¬æ¢ â†’ è¾“å‡º

### ä¸é€‚åˆä½¿ç”¨ AndThen çš„åœºæ™¯

1. âŒ **å•æ­¥æ“ä½œ**ï¼šç®€å•çš„å‡½æ•°è°ƒç”¨ï¼ˆè¿‡åº¦è®¾è®¡ï¼‰
2. âŒ **éœ€è¦ä¸­é—´å€¼**ï¼šæ¯ä¸€æ­¥çš„è¿”å›å€¼éƒ½ä¸åŒä¸”éƒ½éœ€è¦ä½¿ç”¨
3. âŒ **å¹¶è¡Œæ“ä½œ**ï¼šå¤šä¸ªç‹¬ç«‹çš„æ“ä½œä¸ä¾èµ–é¡ºåº

---

## ğŸ“š æ‰©å±•é˜…è¯»

### Rust Result<T, E> å¯¹æ¯”

æœ¬é¡¹ç›®çš„ `Result<T>` è®¾è®¡å— Rust å¯å‘ï¼š

```rust
// Rust ç‰ˆæœ¬
fn open(&self, url: &str) -> Result<(), Error> {
    demuxer.open(url)?
        .and_then(|_| video_decoder.open())
        .and_then(|_| audio_decoder.open())
        .and_then(|_| Ok(create_controller()))
        .map_err(|e| {
            cleanup();
            e
        })
}
```

**ç›¸ä¼¼ç‚¹**ï¼š
- `.and_then()` â‰ˆ C++ `.AndThen()`
- `.map_err()` â‰ˆ C++ `.MapErr()`
- `?` æ“ä½œç¬¦ â‰ˆ C++ çš„è‡ªåŠ¨é”™è¯¯ä¼ æ’­

**å·®å¼‚ç‚¹**ï¼š
- Rust æ˜¯ç¼–è¯‘æœŸå¼ºåˆ¶ï¼ŒC++ ä¾èµ–å¼€å‘è€…è‡ªå¾‹
- Rust çš„ `?` æ›´ç®€æ´ï¼ŒC++ éœ€è¦æ˜¾å¼è°ƒç”¨ `.AndThen()`

---

## âœ… æ€»ç»“

**AndThen é“¾å¼è°ƒç”¨çš„æœ¬è´¨**ï¼š
- ğŸ¯ **æˆåŠŸæ—¶**ï¼šç»§ç»­æ‰§è¡Œä¸‹ä¸€æ­¥
- ğŸ›‘ **å¤±è´¥æ—¶**ï¼šçŸ­è·¯è·³è¿‡åç»­æ­¥éª¤ï¼Œç›´æ¥åˆ° MapErr

**MapErr çš„ä½œç”¨**ï¼š
- ğŸ§¹ **æ¸…ç†èµ„æº**ï¼ˆå‰¯ä½œç”¨ï¼‰
- ğŸ“ **è®°å½•æ—¥å¿—**ï¼ˆå‰¯ä½œç”¨ï¼‰
- ğŸ”„ **è½¬æ¢é”™è¯¯ç **ï¼ˆå¯é€‰ï¼‰

**æœ€ä½³å®è·µ**ï¼š
1. ç”¨ `.AndThen()` ä¸²è”å¤šä¸ª `Result<void>` æ“ä½œ
2. åœ¨æœ€åç”¨ `.MapErr()` ç»Ÿä¸€å¤„ç†é”™è¯¯å’Œæ¸…ç†
3. é¿å…åœ¨ `.AndThen()` å†…éƒ¨æ‰‹åŠ¨æ£€æŸ¥å‰é¢çš„çŠ¶æ€

é€šè¿‡è¿™ç§æ¨¡å¼ï¼Œä»£ç æ›´**å®‰å…¨ã€ç®€æ´ã€æ˜“ç»´æŠ¤**ï¼ğŸ‰
