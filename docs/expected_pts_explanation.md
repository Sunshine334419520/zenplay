# UpdateClock ä¸­ expected_pts æ¨ç®—åŸç†è¯¦è§£

## ğŸ¤” é—®é¢˜

åœ¨ `UpdateAudioClock` å’Œ `UpdateVideoClock` ä¸­æœ‰è¿™æ ·çš„ä»£ç :

```cpp
if (audio_clock_.system_time.time_since_epoch().count() > 0) {
  // æ ¹æ®ä¸Šæ¬¡æ›´æ–°çš„æ—¶é’Ÿï¼Œæ¨ç®—å½“å‰åº”è¯¥çš„PTS
  double expected_pts = audio_clock_.GetCurrentTime(system_time);
  
  // è®¡ç®—å®é™…PTSä¸æ¨ç®—PTSçš„å·®å¼‚
  double drift = normalized_pts - expected_pts;
  
  // æ…¢é€Ÿè°ƒæ•´drift
  audio_clock_.drift = drift * 0.1;
}
```

**ç–‘é—®**:
- PTS ä¸ºä»€ä¹ˆå¯ä»¥æ¨æ–­å‡ºæ¥?
- æ¨æ–­çš„ä¾æ®æ˜¯ä»€ä¹ˆ?
- æ€ä¹ˆå°±ä¼šæ˜¯å‡†ç¡®çš„å‘¢?

---

## ğŸ’¡ æ ¸å¿ƒåŸç†

### ç†æƒ³å‡è®¾: åª’ä½“ä»¥æ’å®šé€Ÿç‡æ’­æ”¾

**å…³é”®è®¤çŸ¥**: 
> åœ¨ç†æƒ³æƒ…å†µä¸‹,åª’ä½“æµåº”è¯¥ä»¥**æ’å®šé€Ÿç‡**æ’­æ”¾ã€‚
> - éŸ³é¢‘: é‡‡æ ·ç‡å›ºå®š (å¦‚ 44100 Hz)
> - è§†é¢‘: å¸§ç‡å›ºå®š (å¦‚ 30 fps)

**æ¨ç®—ä¾æ®**:
```
å¦‚æœåª’ä½“ä»¥æ’å®šé€Ÿç‡æ’­æ”¾,é‚£ä¹ˆ:
  PTS çš„å¢é•¿é€Ÿåº¦ = ç³»ç»Ÿæ—¶é—´çš„æµé€é€Ÿåº¦

å³:
  å½“å‰ PTS = ä¸Šæ¬¡ PTS + ç»è¿‡çš„ç³»ç»Ÿæ—¶é—´
  
  expected_pts = last_pts + (current_time - last_time)
```

---

## ğŸ“Š å…·ä½“ä¾‹å­

### ä¾‹å­ 1: ç†æƒ³çš„éŸ³é¢‘æ’­æ”¾

```
å‡è®¾: éŸ³é¢‘é‡‡æ ·ç‡ 44100 Hz, æ¯æ¬¡ callback å¤„ç† 1024 samples

T0 æ—¶åˆ»:
  UpdateAudioClock(1000ms, T0)
  audio_clock.pts_ms = 1000ms
  audio_clock.system_time = T0

T1 æ—¶åˆ» (23.2ms å, å› ä¸º 1024/44100 â‰ˆ 23.2ms):
  // éŸ³é¢‘ç¡¬ä»¶åº”è¯¥åˆšå¥½æ’­æ”¾å®Œ 1024 samples
  
  ç†è®ºä¸Šåº”è¯¥è°ƒç”¨:
    UpdateAudioClock(1023.2ms, T1)
  
  æ¨ç®—:
    expected_pts = 1000 + (T1 - T0)
                 = 1000 + 23.2
                 = 1023.2ms
  
  å®é™…ä¼ å…¥:
    normalized_pts = 1023.2ms
  
  å¯¹æ¯”:
    drift = 1023.2 - 1023.2 = 0ms  â† å®Œç¾åŒæ­¥!
```

### ä¾‹å­ 2: éŸ³é¢‘ç¡¬ä»¶ç¨å¿«

```
T0: UpdateAudioClock(1000ms, T0)

T1 (23.2ms å):
  // éŸ³é¢‘ç¡¬ä»¶ç¨å¿«,å®é™…å·²ç»æ’­æ”¾åˆ° 1024ms
  
  å®é™…è°ƒç”¨:
    UpdateAudioClock(1024ms, T1)
  
  æ¨ç®—:
    expected_pts = 1000 + 23.2 = 1023.2ms
  
  å®é™…:
    normalized_pts = 1024ms
  
  å¯¹æ¯”:
    drift = 1024 - 1023.2 = 0.8ms  â† ç¡¬ä»¶ç¨å¿«!
    audio_clock.drift = 0.8 * 0.1 = 0.08ms
```

### ä¾‹å­ 3: éŸ³é¢‘ç¡¬ä»¶ç¨æ…¢

```
T0: UpdateAudioClock(1000ms, T0)

T1 (23.2ms å):
  // éŸ³é¢‘ç¡¬ä»¶ç¨æ…¢,å®é™…åªæ’­æ”¾åˆ° 1022ms
  
  å®é™…è°ƒç”¨:
    UpdateAudioClock(1022ms, T1)
  
  æ¨ç®—:
    expected_pts = 1000 + 23.2 = 1023.2ms
  
  å®é™…:
    normalized_pts = 1022ms
  
  å¯¹æ¯”:
    drift = 1022 - 1023.2 = -1.2ms  â† ç¡¬ä»¶ç¨æ…¢!
    audio_clock.drift = -1.2 * 0.1 = -0.12ms
```

---

## ğŸ” GetCurrentTime çš„å®ç°

```cpp
struct Clock {
  std::atomic<double> pts_ms;
  std::chrono::steady_clock::time_point system_time;
  double drift;
  
  double GetCurrentTime(std::chrono::steady_clock::time_point current_time) const {
    // è®¡ç®—ä»ä¸Šæ¬¡æ›´æ–°åˆ°ç°åœ¨çš„æ—¶é—´å·®
    auto elapsed = current_time - system_time;
    double elapsed_ms = std::chrono::duration<double, std::milli>(elapsed).count();
    
    // æ¨ç®—å½“å‰æ’­æ”¾ä½ç½®
    return pts_ms.load() + elapsed_ms + drift;
  }
};
```

**æ¨ç®—å…¬å¼**:
```
expected_pts = last_pts + elapsed_time + drift

å…¶ä¸­:
  last_pts = ä¸Šæ¬¡æ›´æ–°çš„ PTS
  elapsed_time = current_time - last_system_time (ç³»ç»Ÿæ—¶é—´æµé€)
  drift = æ—¶é’Ÿæ¼‚ç§»è¡¥å¿
```

---

## â“ ä¸ºä»€ä¹ˆè¿™ä¸ªæ¨ç®—"åº”è¯¥"å‡†ç¡®?

### ç†ç”± 1: éŸ³é¢‘ç¡¬ä»¶çš„ç¨³å®šæ€§

**éŸ³é¢‘æ’­æ”¾ç”±ç¡¬ä»¶æ™¶æŒ¯é©±åŠ¨**:
- éŸ³é¢‘ç¡¬ä»¶æœ‰ç‹¬ç«‹çš„æ™¶æŒ¯ (å¦‚ 44.1 kHz, 48 kHz)
- æ™¶æŒ¯é¢‘ç‡éå¸¸ç¨³å®š (è¯¯å·® < 0.01%)
- é‡‡æ ·ç‡å‡ ä¹æ’å®š

**ç»“æœ**:
```
å‡è®¾é‡‡æ ·ç‡ 44100 Hz:
  ç†è®º: 1 ç§’æ’­æ”¾ 44100 samples
  å®é™…: 1 ç§’æ’­æ”¾ 44100 Â± 4 samples (è¯¯å·® < 0.01%)

PTS å¢é•¿é€Ÿåº¦ â‰ˆ ç³»ç»Ÿæ—¶é—´æµé€é€Ÿåº¦
```

### ç†ç”± 2: è§†é¢‘æ¸²æŸ“çš„å‘¨æœŸæ€§

**è§†é¢‘ä»¥å›ºå®šå¸§ç‡æ¸²æŸ“**:
- 30 fps â†’ æ¯å¸§ 33.3ms
- 60 fps â†’ æ¯å¸§ 16.7ms

**ç†æƒ³æƒ…å†µ**:
```
T0: UpdateVideoClock(1000ms, T0)
T1 (33.3ms å): UpdateVideoClock(1033.3ms, T1)
T2 (33.3ms å): UpdateVideoClock(1066.6ms, T2)

æ¯æ¬¡é—´éš”éƒ½æ˜¯ 33.3ms,æ¨ç®—éå¸¸å‡†ç¡®!
```

### ç†ç”± 3: ç³»ç»Ÿæ—¶é’Ÿçš„ç²¾åº¦

**steady_clock çš„ç‰¹æ€§**:
- å•è°ƒé€’å¢,ä¸ä¼šå€’é€€
- ç²¾åº¦å¾ˆé«˜ (é€šå¸¸ ns çº§åˆ«)
- ä¸å—ç³»ç»Ÿæ—¶é—´è°ƒæ•´å½±å“

**ç»“æœ**:
```
elapsed_time = current_time - last_time  â† éå¸¸å‡†ç¡®!
```

---

## âš ï¸ ä½†å®é™…ä¸Šå¹¶ä¸æ€»æ˜¯å‡†ç¡®!

### ä¸å‡†ç¡®çš„åŸå›  1: è§£ç å»¶è¿Ÿæ³¢åŠ¨

```
ç†æƒ³æƒ…å†µ:
  T0: decode frame1 â†’ 10ms â†’ UpdateClock(1000ms, T0)
  T1: decode frame2 â†’ 10ms â†’ UpdateClock(1033ms, T0+43ms)
  é—´éš”: 43ms (33ms å¸§é—´éš” + 10ms è§£ç )

å®é™…æƒ…å†µ:
  T0: decode frame1 â†’ 10ms â†’ UpdateClock(1000ms, T0)
  T1: decode frame2 â†’ 25ms â†’ UpdateClock(1033ms, T0+58ms)  â† è§£ç æ…¢äº†!
  é—´éš”: 58ms

æ¨ç®—:
  expected_pts = 1000 + 58 = 1058ms
  actual_pts = 1033ms
  drift = 1033 - 1058 = -25ms  â† æ£€æµ‹åˆ°å»¶è¿Ÿ!
```

### ä¸å‡†ç¡®çš„åŸå›  2: ç³»ç»Ÿè´Ÿè½½

```
é«˜è´Ÿè½½åœºæ™¯:
  T0: UpdateClock(1000ms, T0)
  
  // ç³»ç»Ÿå¡é¡¿ 100ms
  
  T1 (å®é™…è¿‡äº† 133ms):
    UpdateClock(1033ms, T1)
  
  æ¨ç®—:
    expected_pts = 1000 + 133 = 1133ms
  
  å®é™…:
    actual_pts = 1033ms
  
  drift = 1033 - 1133 = -100ms  â† ç³»ç»Ÿå¡é¡¿!
```

### ä¸å‡†ç¡®çš„åŸå›  3: éŸ³é¢‘ç¡¬ä»¶æ¼‚ç§»

```
éŸ³é¢‘ç¡¬ä»¶å®é™…é‡‡æ ·ç‡å¯èƒ½ä¸æ˜¯ç²¾ç¡®çš„ 44100 Hz:
  
  æ ‡ç§°: 44100 Hz
  å®é™…: 44110 Hz (å¿«äº† 0.02%)

é•¿æ—¶é—´æ’­æ”¾å:
  T0: 0ms
  T1000s å:
    ç†è®º PTS: 1000s
    å®é™… PTS: 1000.2s  â† å¿«äº† 200ms!
  
  drift ä¼šæ…¢æ…¢ç´¯ç§¯
```

---

## ğŸ¯ drift çš„ä½œç”¨: è¡¥å¿è¯¯å·®

### drift è®¡ç®—å…¬å¼

```cpp
// è®¡ç®—å®é™…PTSä¸æ¨ç®—PTSçš„å·®å¼‚
double drift = normalized_pts - expected_pts;

// æ…¢é€Ÿè°ƒæ•´driftï¼ˆç³»æ•°0.1ï¼‰ï¼Œé¿å…æ—¶é’Ÿçªç„¶è·³å˜
audio_clock_.drift = drift * 0.1;
```

### ä¸ºä»€ä¹ˆç”¨ 0.1 ç³»æ•°?

**æ…¢é€Ÿè°ƒæ•´çš„åŸå› **:

```
åœºæ™¯: å¶å°”çš„è§£ç å»¶è¿Ÿ

ä¸ä½¿ç”¨ç³»æ•° (drift = ç›´æ¥å·®å€¼):
  T0: drift = 0ms
  T1: å¶ç„¶å»¶è¿Ÿ â†’ drift = -20ms  â† æ—¶é’Ÿçªç„¶è·³å˜!
  T2: æ¢å¤æ­£å¸¸ â†’ drift = 0ms   â† åˆè·³å›æ¥!
  
  ç»“æœ: æ—¶é’ŸæŠ–åŠ¨,éŸ³è§†é¢‘ä¸ç¨³å®š

ä½¿ç”¨ 0.1 ç³»æ•° (drift *= 0.1):
  T0: drift = 0ms
  T1: å¶ç„¶å»¶è¿Ÿ â†’ drift = -20 * 0.1 = -2ms  â† ç¼“æ…¢è°ƒæ•´
  T2: æ¢å¤æ­£å¸¸ â†’ drift = -2 * 0.9 = -1.8ms  â† ç¼“æ…¢æ¢å¤
  T3: drift = -1.8 * 0.9 = -1.6ms
  ...
  T10: drift â‰ˆ 0ms
  
  ç»“æœ: æ—¶é’Ÿå¹³æ»‘,éŸ³è§†é¢‘ç¨³å®š
```

### drift çš„æ•ˆæœ

```cpp
double GetCurrentTime(current_time) const {
  auto elapsed = current_time - system_time;
  double elapsed_ms = duration_cast<milliseconds>(elapsed).count();
  
  // drift æä¾›å°å¹…è¡¥å¿
  return pts_ms.load() + elapsed_ms + drift;
  //                                   â†‘
  //                         è¡¥å¿ç¡¬ä»¶/ç³»ç»Ÿçš„å¾®å°è¯¯å·®
}
```

**ä¾‹å­**:
```
éŸ³é¢‘ç¡¬ä»¶ç¨å¿« (æ¯ç§’å¿« 10ms):

ç»è¿‡ 10 ç§’:
  ç´¯ç§¯çš„ drift â‰ˆ 10ms
  
GetCurrentTime():
  return 10000 + 0 + 10 = 10010ms
  
ä½œç”¨: è¡¥å¿äº†ç¡¬ä»¶çš„ 10ms åå¿«
```

---

## ğŸ“Š å®Œæ•´æµç¨‹ç¤ºä¾‹

### æ­£å¸¸æ’­æ”¾åœºæ™¯

```
åˆå§‹çŠ¶æ€:
  audio_clock.pts_ms = 0
  audio_clock.system_time = T0
  audio_clock.drift = 0

ç¬¬1æ¬¡æ›´æ–° (T0 + 23ms):
  å®é™…è°ƒç”¨: UpdateAudioClock(23ms, T0+23ms)
  
  æ¨ç®—:
    expected_pts = 0 + 23 + 0 = 23ms
  
  å®é™…:
    normalized_pts = 23ms
  
  drift:
    drift = (23 - 23) * 0.1 = 0ms
  
  æ›´æ–°:
    audio_clock.pts_ms = 23ms
    audio_clock.system_time = T0 + 23ms
    audio_clock.drift = 0ms

ç¬¬2æ¬¡æ›´æ–° (T0 + 46ms):
  å®é™…è°ƒç”¨: UpdateAudioClock(46ms, T0+46ms)
  
  æ¨ç®—:
    expected_pts = 23 + 23 + 0 = 46ms
  
  å®é™…:
    normalized_pts = 46ms
  
  drift:
    drift = (46 - 46) * 0.1 = 0ms
  
  æ›´æ–°:
    audio_clock.pts_ms = 46ms
    audio_clock.system_time = T0 + 46ms
    audio_clock.drift = 0ms
```

### ç¡¬ä»¶ç¨å¿«åœºæ™¯

```
ç¬¬1æ¬¡æ›´æ–° (T0 + 23ms):
  å®é™…è°ƒç”¨: UpdateAudioClock(23ms, T0+23ms)
  drift = 0ms

ç¬¬2æ¬¡æ›´æ–° (T0 + 46ms):
  // ç¡¬ä»¶ç¨å¿«,å®é™…æ’­æ”¾åˆ° 47ms
  å®é™…è°ƒç”¨: UpdateAudioClock(47ms, T0+46ms)
  
  æ¨ç®—:
    expected_pts = 23 + 23 + 0 = 46ms
  
  å®é™…:
    normalized_pts = 47ms
  
  drift:
    drift = (47 - 46) * 0.1 = 0.1ms  â† æ£€æµ‹åˆ°ç¡¬ä»¶å¿«äº† 1ms
  
  æ›´æ–°:
    audio_clock.drift = 0.1ms

ç¬¬3æ¬¡æ›´æ–° (T0 + 69ms):
  å®é™…è°ƒç”¨: UpdateAudioClock(70ms, T0+69ms)
  
  æ¨ç®—:
    expected_pts = 47 + 23 + 0.1 = 70.1ms  â† drift å‚ä¸è®¡ç®—
  
  å®é™…:
    normalized_pts = 70ms
  
  drift:
    drift = (70 - 70.1) * 0.1 = -0.01ms  â† è¯¯å·®åœ¨ç¼©å°
  
  æ›´æ–°:
    audio_clock.drift = -0.01ms  â† æ¥è¿‘ 0
```

---

## ğŸ¯ æ€»ç»“

### ä¸ºä»€ä¹ˆå¯ä»¥æ¨ç®— PTS?

1. **ç†æƒ³å‡è®¾**: åª’ä½“ä»¥æ’å®šé€Ÿç‡æ’­æ”¾
   - éŸ³é¢‘: é‡‡æ ·ç‡å›ºå®š
   - è§†é¢‘: å¸§ç‡å›ºå®š

2. **æ¨ç®—å…¬å¼**: `expected_pts = last_pts + elapsed_time + drift`
   - `elapsed_time`: ç³»ç»Ÿæ—¶é—´æµé€ (éå¸¸å‡†ç¡®)
   - `drift`: ç´¯ç§¯çš„ç¡¬ä»¶åå·®è¡¥å¿

3. **ç¡¬ä»¶ç¨³å®šæ€§**: éŸ³é¢‘ç¡¬ä»¶æ™¶æŒ¯éå¸¸ç¨³å®š
   - è¯¯å·® < 0.01%
   - PTS å¢é•¿ â‰ˆ æ—¶é—´æµé€

### ä¸ºä»€ä¹ˆ"åº”è¯¥"å‡†ç¡®?

1. âœ… **éŸ³é¢‘ç¡¬ä»¶**: æ™¶æŒ¯é©±åŠ¨,é€Ÿç‡æ’å®š
2. âœ… **è§†é¢‘å¸§ç‡**: å‘¨æœŸæ€§æ¸²æŸ“,é—´éš”å›ºå®š
3. âœ… **ç³»ç»Ÿæ—¶é’Ÿ**: ç²¾åº¦é«˜,å•è°ƒé€’å¢

### ä¸ºä»€ä¹ˆå®é™…å¯èƒ½ä¸å‡†?

1. âš ï¸ **è§£ç å»¶è¿Ÿ**: æ³¢åŠ¨å¯¼è‡´é—´éš”ä¸å‡
2. âš ï¸ **ç³»ç»Ÿè´Ÿè½½**: å¡é¡¿å¯¼è‡´æ—¶é—´å¼‚å¸¸
3. âš ï¸ **ç¡¬ä»¶æ¼‚ç§»**: é•¿æ—¶é—´ç´¯ç§¯è¯¯å·®

### drift çš„ä½œç”¨

1. **æ£€æµ‹åå·®**: `drift = actual - expected`
2. **è¡¥å¿è¯¯å·®**: `GetCurrentTime` åŠ ä¸Š drift
3. **å¹³æ»‘è°ƒæ•´**: ä½¿ç”¨ 0.1 ç³»æ•°é¿å…æŠ–åŠ¨

---

## ğŸ”§ è®¾è®¡æ„å›¾

è¿™ä¸ªæœºåˆ¶çš„ç›®çš„**ä¸æ˜¯**è®© expected_pts 100% å‡†ç¡®,è€Œæ˜¯:

1. **æ£€æµ‹å¼‚å¸¸**: å‘ç°ç¡¬ä»¶/ç³»ç»Ÿçš„åå·®
2. **å¹³æ»‘è¡¥å¿**: ç¼“æ…¢è°ƒæ•´ drift,é¿å…çªå˜
3. **ä¿æŒç¨³å®š**: å³ä½¿æœ‰å°è¯¯å·®,ä¹Ÿèƒ½ä¿æŒéŸ³è§†é¢‘åŒæ­¥

**å…³é”®**: 
> æ¨ç®—ä¸éœ€è¦å®Œç¾å‡†ç¡®,åªéœ€è¦è¶³å¤Ÿæ¥è¿‘çœŸå®å€¼,
> drift ä¼šè‡ªåŠ¨è¡¥å¿å°è¯¯å·®,ä¿æŒæ—¶é’Ÿç¨³å®š!

---

## ğŸ’¡ ç±»æ¯”

**æ±½è½¦å®šé€Ÿå·¡èˆª**:

```
è®¾å®š: 100 km/h

æ¨ç®—å½“å‰ä½ç½®:
  expected_position = last_position + (current_time - last_time) * 100
  
å®é™…æµ‹é‡:
  actual_position = GPS æµ‹é‡
  
åå·®:
  drift = actual - expected
  
  å¦‚æœ drift > 0: è½¦é€Ÿç¨å¿«,å‡é€Ÿ
  å¦‚æœ drift < 0: è½¦é€Ÿç¨æ…¢,åŠ é€Ÿ

ç»“æœ:
  è™½ç„¶æ¯æ¬¡æµ‹é‡æœ‰è¯¯å·®,ä½†é€šè¿‡ä¸æ–­è°ƒæ•´,
  é•¿æœŸä¿æŒåœ¨ 100 km/h é™„è¿‘!
```

**æ—¶é’Ÿæ¨ç®—ä¹Ÿæ˜¯åŒæ ·çš„é“ç†**! âœ…
