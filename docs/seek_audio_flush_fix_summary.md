# Seek åéŸ³é¢‘æ®‹ç•™é—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜

Seek æ“ä½œåä¼šæ’­æ”¾ä¸€å°æ®µä¹‹å‰ä½ç½®çš„éŸ³é¢‘æ•°æ®ï¼ˆçº¦0.5-1ç§’ï¼‰ã€‚

## ğŸ” æ ¹æœ¬åŸå› 

è™½ç„¶è½¯ä»¶å±‚çš„é˜Ÿåˆ—è¢«æ¸…ç©ºäº†ï¼Œä½†**éŸ³é¢‘ç¡¬ä»¶ç¼“å†²åŒº**ï¼ˆWASAPI bufferï¼‰ä¸­ä»æœ‰æ—§æ•°æ®åœ¨æ’­æ”¾ã€‚

```
WASAPI ç¡¬ä»¶ç¼“å†²åŒºï¼šçº¦ 1 ç§’éŸ³é¢‘ (44100 å¸§)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ æ—§éŸ³é¢‘æ•°æ® â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚
â”‚ â†‘ è¿™äº›æ•°æ®åœ¨ Seek åä»ä¼šæ’­æ”¾            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… è§£å†³æ–¹æ¡ˆ

æ·»åŠ  `Flush()` æ¥å£ï¼Œè°ƒç”¨ `IAudioClient::Reset()` æ¸…ç©ºç¡¬ä»¶ç¼“å†²åŒºã€‚

### ä»£ç ä¿®æ”¹

**1. audio_output.h** - æ·»åŠ æ¥å£
```cpp
virtual void Flush() = 0;
```

**2. wasapi_audio_output.h/cpp** - å®ç°æ¥å£
```cpp
void WasapiAudioOutput::Flush() {
  if (audio_client_) {
    audio_client_->Reset();  // æ¸…ç©ºç¡¬ä»¶ç¼“å†²åŒº
  }
}
```

**3. audio_player.h/cpp** - å°è£…æ–¹æ³•
```cpp
void AudioPlayer::Flush() {
  ClearFrames();              // æ¸…ç©ºè½¯ä»¶ç¼“å†²åŒº
  audio_output_->Flush();     // æ¸…ç©ºç¡¬ä»¶ç¼“å†²åŒº
}
```

**4. playback_controller.cpp** - Seek ä¸­è°ƒç”¨
```cpp
Seek() {
  Pause();
  ClearAllQueues();
  audio_player_->Flush();  // âœ… æ–°å¢ï¼šæ¸…ç©ºç¡¬ä»¶ç¼“å†²åŒº
  Demuxer::Seek();
  Resume();
}
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| Seek åéŸ³é¢‘ | âŒ æ’­æ”¾ 0.5-1 ç§’æ—§éŸ³é¢‘ | âœ… ç«‹å³æ’­æ”¾æ–°ä½ç½®éŸ³é¢‘ |
| éŸ³ç”»åŒæ­¥ | âš ï¸ Seek åçŸ­æš‚ä¸åŒæ­¥ | âœ… å®Œå…¨åŒæ­¥ |
| ç”¨æˆ·ä½“éªŒ | âŒ æœ‰æ˜æ˜¾å»¶è¿Ÿæ„Ÿ | âœ… å³æ—¶å“åº” |

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### IAudioClient::Reset()

- **ä½œç”¨**ï¼šæ¸…ç©º WASAPI ç¡¬ä»¶ç¼“å†²åŒºçš„æ‰€æœ‰æ•°æ®
- **è¦æ±‚**ï¼šå¿…é¡»åœ¨éŸ³é¢‘æµåœæ­¢æ—¶è°ƒç”¨ï¼ˆPause åï¼‰
- **æ•ˆæœ**ï¼šä¸‹æ¬¡æ’­æ”¾ä»å¹²å‡€çš„ç¼“å†²åŒºå¼€å§‹

### è°ƒç”¨é¡ºåºï¼ˆSeekï¼‰

```
1. Pause()                    âœ… åœæ­¢éŸ³é¢‘æµ
2. ClearAllQueues()           âœ… æ¸…ç©ºè½¯ä»¶é˜Ÿåˆ—
3. audio_player_->Flush()     âœ… æ¸…ç©ºç¡¬ä»¶ç¼“å†²åŒº
   â””â”€ ClearFrames()          (frame_queue_, internal_buffer_)
   â””â”€ audio_output_->Flush() (WASAPI buffer)
4. Demuxer::Seek()            âœ… å®šä½åˆ°æ–°ä½ç½®
5. Resume()                   âœ… æ¢å¤æ’­æ”¾
```

## âœ… æµ‹è¯•å»ºè®®

1. **åŸºæœ¬ Seek**ï¼šæ’­æ”¾åˆ° 30 ç§’ â†’ Seek åˆ° 60 ç§’ â†’ è§‚å¯Ÿæ˜¯å¦ç«‹å³æ’­æ”¾ 60 ç§’éŸ³é¢‘
2. **è¿ç»­ Seek**ï¼šå¿«é€Ÿå¤šæ¬¡ Seek â†’ è§‚å¯Ÿæ˜¯å¦æ¯æ¬¡éƒ½å¹²å‡€åˆ‡æ¢
3. **æš‚åœå Seek**ï¼šæš‚åœ â†’ Seek â†’ æ’­æ”¾ â†’ è§‚å¯Ÿæ˜¯å¦æ­£å¸¸

## ğŸ“ æ–‡ä»¶ä¿®æ”¹åˆ—è¡¨

- âœ… `src/player/audio/audio_output.h`
- âœ… `src/player/audio/impl/wasapi_audio_output.h`
- âœ… `src/player/audio/impl/wasapi_audio_output.cpp`
- âœ… `src/player/audio/audio_player.h`
- âœ… `src/player/audio/audio_player.cpp`
- âœ… `src/player/playback_controller.cpp`
- âœ… `docs/audio_hardware_buffer_flush_fix.md`ï¼ˆè¯¦ç»†æ–‡æ¡£ï¼‰
- âœ… `docs/audio_internal_buffer_fix.md`ï¼ˆè½¯ä»¶ç¼“å†²åŒºä¿®å¤ï¼‰

---

**ä¿®å¤å®Œæˆï¼Seek åéŸ³é¢‘å°†ç«‹å³ä»æ–°ä½ç½®æ’­æ”¾ï¼Œæ— æ—§éŸ³é¢‘æ®‹ç•™ã€‚** ğŸ‰
