# ğŸ“ ZenPlay æ•´ä½“æ¶æ„è®¾è®¡

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **æœ€åæ›´æ–°**: 2025-11-18  
> **ç›¸å…³æ–‡æ¡£**: [æ ¸å¿ƒç»„ä»¶è¯¦è§£](core_components.md) | [çŠ¶æ€ç®¡ç†ç³»ç»Ÿ](state_management.md)

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è§ˆ

æœ¬æ–‡æ¡£ä»å®è§‚è§†è§’ä»‹ç» ZenPlay åª’ä½“æ’­æ”¾å™¨çš„æ•´ä½“æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬ï¼š
- äº”å±‚æ¶æ„åˆ†å±‚æ¨¡å‹
- æ ¸å¿ƒè®¾è®¡åŸåˆ™ä¸æŠ€æœ¯å†³ç­–
- æ•°æ®æµè½¬ä¸å¤„ç†æµç¨‹
- å¤šçº¿ç¨‹åä½œæ¨¡å‹
- å…³é”®æŠ€æœ¯äº®ç‚¹

**é˜…è¯»å»ºè®®**: 
- é¦–æ¬¡é˜…è¯»å»ºè®®ä»å¤´åˆ°å°¾å®Œæ•´é˜…è¯»
- æ·±å…¥äº†è§£å„æ¨¡å—åï¼Œå¯è·³è½¬åˆ° [æ ¸å¿ƒç»„ä»¶è¯¦è§£](core_components.md)
- äº†è§£çŠ¶æ€æœºåˆ¶åï¼Œå¯å‚è€ƒ [çŠ¶æ€ç®¡ç†ç³»ç»Ÿ](state_management.md)

---

## ğŸ›ï¸ äº”å±‚æ¶æ„è®¾è®¡

ZenPlay é‡‡ç”¨ç»å…¸çš„åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œä»ä¸Šåˆ°ä¸‹åˆ†ä¸ºäº”å±‚ï¼Œæ¯å±‚èŒè´£æ¸…æ™°ã€ä¾èµ–å…³ç³»æ˜ç¡®ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Layer 1: UI å±‚                            â”‚
â”‚                      (Qt6 Widgets + QML)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MainWindow   â”‚  â”‚VideoDisplay  â”‚  â”‚  ControlBar/Slider   â”‚  â”‚
â”‚  â”‚              â”‚  â”‚   Widget     â”‚  â”‚  (Play/Pause/Seek)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     Layer 2: åº”ç”¨å±‚                              â”‚
â”‚                        (ZenPlayer)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ Open/Close åª’ä½“æ–‡ä»¶                                    â”‚   â”‚
â”‚  â”‚  â€¢ Play/Pause/Stop/Seek æ§åˆ¶                             â”‚   â”‚
â”‚  â”‚  â€¢ SetRenderWindow è®¾ç½®æ¸²æŸ“çª—å£                          â”‚   â”‚
â”‚  â”‚  â€¢ çŠ¶æ€å˜æ›´å›è°ƒæ³¨å†Œ                                      â”‚   â”‚
â”‚  â”‚  â€¢ ç»Ÿä¸€çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      Layer 3: æ ¸å¿ƒå±‚                             â”‚
â”‚                   (PlaybackController)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚PlaybackCtrl   â”‚  â”‚AVSyncController â”‚  â”‚ BlockingQueue<T>â”‚   â”‚
â”‚  â”‚ â€¢ çº¿ç¨‹ç®¡ç†    â”‚  â”‚ â€¢ ä¸»æ—¶é’Ÿé€‰æ‹©    â”‚  â”‚ â€¢ çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—  â”‚   â”‚
â”‚  â”‚ â€¢ æ•°æ®æµåè°ƒ  â”‚  â”‚ â€¢ åŒæ­¥ç®—æ³•      â”‚  â”‚ â€¢ ç”Ÿäº§è€…-æ¶ˆè´¹è€… â”‚   â”‚
â”‚  â”‚ â€¢ æ’­æ”¾æ§åˆ¶    â”‚  â”‚ â€¢ æ—¶é’Ÿæ›´æ–°      â”‚  â”‚ â€¢ èƒŒå‹æ§åˆ¶      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     Layer 4: ç»„ä»¶å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Demuxer     â”‚  â”‚  Decoders    â”‚  â”‚   Players            â”‚  â”‚
â”‚  â”‚ â€¢ è§£å°è£…     â”‚  â”‚ â€¢ VideoDecoderâ”‚ â”‚ â€¢ AudioPlayer        â”‚  â”‚
â”‚  â”‚ â€¢ æµé€‰æ‹©     â”‚  â”‚ â€¢ AudioDecoderâ”‚ â”‚ â€¢ VideoPlayer        â”‚  â”‚
â”‚  â”‚ â€¢ Seekè·³è½¬   â”‚  â”‚ â€¢ ç¡¬ä»¶åŠ é€Ÿ   â”‚  â”‚ â€¢ æ’­æ”¾é˜Ÿåˆ—ç®¡ç†       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ AudioResampler   â”‚  â”‚  HWDecoderContext / Renderer     â”‚    â”‚
â”‚  â”‚ â€¢ æ ¼å¼è½¬æ¢       â”‚  â”‚ â€¢ D3D11è®¾å¤‡ç®¡ç† / çº¹ç†æ¸²æŸ“       â”‚    â”‚
â”‚  â”‚ â€¢ SIMDä¼˜åŒ–       â”‚  â”‚ â€¢ é›¶æ‹·è´æ”¯æŒ    / ç¡¬ä»¶åŠ é€Ÿ       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      Layer 5: å¹³å°å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚AudioOutput   â”‚  â”‚  Renderer    â”‚  â”‚  Threading           â”‚  â”‚
â”‚  â”‚â€¢ WASAPI(Win) â”‚  â”‚ â€¢ SDL2æ¸²æŸ“å™¨ â”‚  â”‚ â€¢ std::thread        â”‚  â”‚
â”‚  â”‚â€¢ ALSA(Linux) â”‚  â”‚ â€¢ D3D11æ¸²æŸ“å™¨â”‚  â”‚ â€¢ std::atomic        â”‚  â”‚
â”‚  â”‚â€¢ CoreAudio   â”‚  â”‚ â€¢ é›¶æ‹·è´æ¸²æŸ“ â”‚  â”‚ â€¢ std::mutex/cv      â”‚  â”‚
â”‚  â”‚  (macOS)     â”‚  â”‚              â”‚  â”‚ â€¢ BlockingQueue      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ†å±‚èŒè´£è¯´æ˜

| å±‚çº§ | åç§° | æ ¸å¿ƒèŒè´£ | å…³é”®ç±» |
|------|------|---------|--------|
| **L1** | **UI å±‚** | ç”¨æˆ·äº¤äº’ã€ç•Œé¢å±•ç¤º | `MainWindow`, `VideoDisplayWidget` |
| **L2** | **åº”ç”¨å±‚** | ç»Ÿä¸€æ¥å£ã€ç”Ÿå‘½å‘¨æœŸç®¡ç† | `ZenPlayer` |
| **L3** | **æ ¸å¿ƒå±‚** | çº¿ç¨‹åè°ƒã€åŒæ­¥æ§åˆ¶ã€æ•°æ®æµç®¡ç† | `PlaybackController`, `AVSyncController` |
| **L4** | **ç»„ä»¶å±‚** | è§£å°è£…ã€è§£ç ã€æ’­æ”¾ã€é‡é‡‡æ · | `Demuxer`, `Decoder`, `AudioPlayer`, `VideoPlayer` |
| **L5** | **å¹³å°å±‚** | è·¨å¹³å°æŠ½è±¡ã€ç¡¬ä»¶è®¿é—® | `AudioOutput`, `Renderer` |

### æ¶æ„ä¼˜åŠ¿

1. **èŒè´£åˆ†ç¦»**: æ¯å±‚åªå…³æ³¨è‡ªå·±çš„èŒè´£ï¼Œé™ä½è€¦åˆ
2. **ä¾èµ–å•å‘**: ä¸Šå±‚ä¾èµ–ä¸‹å±‚ï¼Œä¸‹å±‚ä¸ä¾èµ–ä¸Šå±‚ï¼Œé¿å…å¾ªç¯ä¾èµ–
3. **æ˜“äºæµ‹è¯•**: æ¯å±‚å¯ç‹¬ç«‹æµ‹è¯•ï¼Œå¹³å°å±‚å¯ Mock
4. **è·¨å¹³å°æ”¯æŒ**: å¹³å°å·®å¼‚å°è£…åœ¨æœ€åº•å±‚
5. **æ˜“äºæ‰©å±•**: æ–°å¢åŠŸèƒ½åªéœ€åœ¨å¯¹åº”å±‚å®ç°

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. **å•ä¸€èŒè´£åŸåˆ™ (SRP)**

æ¯ä¸ªç±»/æ¨¡å—åªè´Ÿè´£ä¸€é¡¹æ˜ç¡®çš„èŒè´£ï¼š

- `ZenPlayer`: ç»Ÿä¸€å¯¹å¤–æ¥å£ï¼Œä¸æ¶‰åŠå…·ä½“å®ç°
- `PlaybackController`: åè°ƒæ‰€æœ‰çº¿ç¨‹ï¼Œä¸å¤„ç†å…·ä½“è§£ç 
- `AudioPlayer`: ç®¡ç†éŸ³é¢‘æ’­æ”¾é˜Ÿåˆ—ï¼Œä¸è´Ÿè´£é‡é‡‡æ ·
- `AudioResampler`: ç‹¬ç«‹çš„é‡é‡‡æ ·æ¨¡å—ï¼Œä¸æ¶‰åŠæ’­æ”¾é€»è¾‘

### 2. **ä¾èµ–å€’ç½®åŸåˆ™ (DIP)**

ä¾èµ–æŠ½è±¡æ¥å£ï¼Œè€Œéå…·ä½“å®ç°ï¼š

```cpp
// æŠ½è±¡æ¥å£
class Renderer {
 public:
  virtual Result<void> Init(void* window_handle, int width, int height) = 0;
  virtual bool RenderFrame(AVFrame* frame) = 0;
  virtual void Clear() = 0;
  virtual void Present() = 0;
  // ...
};

// å…·ä½“å®ç°
class SDL2Renderer : public Renderer { /*...*/ };
class D3D11Renderer : public Renderer { /*...*/ };
```

ç±»ä¼¼çš„æŠ½è±¡è¿˜æœ‰ï¼š
- `AudioOutput` (WASAPIã€ALSAã€CoreAudio)
- `Decoder` (VideoDecoderã€AudioDecoder)

### 3. **å…³æ³¨ç‚¹åˆ†ç¦» (SoC)**

**éŸ³è§†é¢‘å¯¹ç§°è®¾è®¡** - AudioPlayer å’Œ VideoPlayer åœ°ä½å¹³ç­‰ï¼š

```cpp
class PlaybackController {
 private:
  std::unique_ptr<AudioPlayer> audio_player_;  // éŸ³é¢‘æ’­æ”¾å™¨
  std::unique_ptr<VideoPlayer> video_player_;  // è§†é¢‘æ’­æ”¾å™¨
  std::unique_ptr<AVSyncController> av_sync_controller_;  // åŒæ­¥æ§åˆ¶å™¨
};
```

ä¸¤è€…éƒ½ï¼š
- æ‹¥æœ‰ç‹¬ç«‹çš„å¸§é˜Ÿåˆ— (`BlockingQueue<T>`)
- æ‹¥æœ‰ç‹¬ç«‹çš„çº¿ç¨‹ (AudioCallbackã€VideoRenderThread)
- å®ç°ç›¸åŒçš„æ§åˆ¶æ¥å£ (`Start/Stop/Pause/Resume`)
- é€šè¿‡ `AVSyncController` åä½œåŒæ­¥

### 4. **çŠ¶æ€ç®¡ç†ç»Ÿä¸€åŒ–**

ä½¿ç”¨ `PlayerStateManager` ä½œä¸º**å•ä¸€çŠ¶æ€æº (Single Source of Truth)**ï¼š

```cpp
// æ‰€æœ‰ç»„ä»¶å…±äº«åŒä¸€ä¸ªçŠ¶æ€ç®¡ç†å™¨
class PlaybackController {
  std::shared_ptr<PlayerStateManager> state_manager_;
};

class AudioPlayer {
  PlayerStateManager* state_manager_;  // å¼•ç”¨ï¼ˆä¸æ‹¥æœ‰ï¼‰
};

class VideoPlayer {
  PlayerStateManager* state_manager_;  // å¼•ç”¨ï¼ˆä¸æ‹¥æœ‰ï¼‰
};
```

**ä¼˜åŠ¿**:
- é¿å…çŠ¶æ€ä¸ä¸€è‡´
- çº¿ç¨‹å®‰å…¨çš„çŠ¶æ€æŸ¥è¯¢å’Œè½¬æ¢
- ç»Ÿä¸€çš„çŠ¶æ€å˜æ›´é€šçŸ¥
- è¯¦è§ [çŠ¶æ€ç®¡ç†ç³»ç»Ÿ](state_management.md)

### 5. **ç°ä»£ C++ æœ€ä½³å®è·µ**

- **æ™ºèƒ½æŒ‡é’ˆ**: `std::unique_ptr`ã€`std::shared_ptr` ç®¡ç†èµ„æº
- **RAII**: èµ„æºè·å–å³åˆå§‹åŒ–ï¼Œè‡ªåŠ¨é‡Šæ”¾
- **åŸå­æ“ä½œ**: `std::atomic` ä¿è¯çº¿ç¨‹å®‰å…¨
- **ç§»åŠ¨è¯­ä¹‰**: `std::move` é¿å…ä¸å¿…è¦çš„æ‹·è´
- **Result<T> æ¨¡å¼**: ç±»å‹å®‰å…¨çš„é”™è¯¯å¤„ç† 

```cpp
// Result<T> é”™è¯¯ä¼ æ’­ç¤ºä¾‹
Result<void> ZenPlayer::Open(const std::string& url) {
  return demuxer_->Open(url)
      .AndThen([this]() { return InitializeVideoRenderingPipeline(); })
      .AndThen([this]() { return InitializeAudioDecoder(); })
      .AndThen([this]() { 
        playback_controller_ = std::make_unique<PlaybackController>(...);
        return Result<void>::Ok();
      })
      .MapErr([this](ErrorCode code) {
        CleanupResources();
        return code;
      });
}
```

[ResultTè¯¦ç»†ä½¿ç”¨æŒ‡å—](result_quick_reference.md)

---

## ğŸ”„ æ•°æ®æµè½¬å…¨æµç¨‹

### æ•´ä½“æµç¨‹å›¾

```mermaid
graph TB
    A[åª’ä½“æ–‡ä»¶/ç½‘ç»œæµ] --> B[Demuxer è§£å°è£…]
    B --> C{æ•°æ®åŒ…ç±»å‹}
    
    C -->|è§†é¢‘åŒ…| D[VideoPacketQueue]
    C -->|éŸ³é¢‘åŒ…| E[AudioPacketQueue]
    
    D --> F[VideoDecoder è§£ç ]
    E --> G[AudioDecoder è§£ç ]
    
    F --> H[VideoFrameQueue]
    G --> I[AudioResampler é‡é‡‡æ ·]
    
    I --> J[ResampledFrameQueue]
    
    H --> K[VideoPlayer]
    J --> L[AudioPlayer]
    
    K --> M[AVSyncController åŒæ­¥]
    L --> M
    
    M --> N[Renderer æ¸²æŸ“åˆ°å±å¹•]
    M --> O[AudioOutput è¾“å‡ºåˆ°å£°å¡]
    
    N --> P[ç”¨æˆ·çœ‹åˆ°ç”»é¢]
    O --> Q[ç”¨æˆ·å¬åˆ°å£°éŸ³]
```


## ğŸ§µ å¤šçº¿ç¨‹åä½œæ¨¡å‹

ZenPlay ä½¿ç”¨ **5 ä¸ªæ ¸å¿ƒçº¿ç¨‹** ååŒå·¥ä½œï¼Œé€šè¿‡ `BlockingQueue` å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ã€‚

### çº¿ç¨‹æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Main Thread (UI)                         â”‚
â”‚  â€¢ ç”¨æˆ·äº¤äº’å¤„ç†                                               â”‚
â”‚  â€¢ çŠ¶æ€å˜æ›´å›è°ƒ                                               â”‚
â”‚  â€¢ RendererProxy è·¨çº¿ç¨‹è°ƒç”¨                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PlaybackController                          â”‚
â”‚                   (ç®¡ç†æ‰€æœ‰å·¥ä½œçº¿ç¨‹)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚          â”‚          â”‚          â”‚          â”‚
    â–¼          â–¼          â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Demux   â”‚ â”‚Video    â”‚ â”‚Audio    â”‚ â”‚Video    â”‚ â”‚Audio        â”‚
â”‚ Thread  â”‚ â”‚Decode   â”‚ â”‚Decode   â”‚ â”‚Render   â”‚ â”‚Callback     â”‚
â”‚         â”‚ â”‚Thread   â”‚ â”‚Thread   â”‚ â”‚Thread   â”‚ â”‚(ç³»ç»Ÿé©±åŠ¨)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚          â”‚          â”‚          â”‚          â”‚
    â–¼          â–¼          â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Video    â”‚ â”‚Video    â”‚ â”‚Audio    â”‚ â”‚Renderer â”‚ â”‚AudioOutput  â”‚
â”‚Packet   â”‚ â”‚Frame    â”‚ â”‚Frame    â”‚ â”‚         â”‚ â”‚             â”‚
â”‚Queue    â”‚ â”‚Queue    â”‚ â”‚Queue    â”‚ â”‚         â”‚ â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çº¿ç¨‹è¯¦ç»†è¯´æ˜

| çº¿ç¨‹åç§° | åˆ›å»ºè€… | ç”Ÿå‘½å‘¨æœŸ | æ ¸å¿ƒèŒè´£ |
|---------|--------|---------|---------|
| **DemuxTask** | `PlaybackController` | Start() â†’ Stop() | è§£å°è£…ï¼Œæ•°æ®åŒ…åˆ†å‘ |
| **VideoDecodeTask** | `PlaybackController` | Start() â†’ Stop() | è§†é¢‘è§£ç ï¼Œé›¶æ‹·è´éªŒè¯ |
| **AudioDecodeTask** | `PlaybackController` | Start() â†’ Stop() | éŸ³é¢‘è§£ç  + é¢„é‡é‡‡æ · |
| **VideoRenderThread** | `VideoPlayer` | Init() â†’ Stop() | è§†é¢‘æ¸²æŸ“ï¼Œæ—¶åºæ§åˆ¶ |
| **AudioCallback** | `AudioOutput` | Start() â†’ Stop() | éŸ³é¢‘è¾“å‡ºï¼Œæ—¶é’Ÿæ›´æ–° |
| **SyncControlTask** | `PlaybackController` | Start() â†’ Stop() | åŒæ­¥ç›‘æ§ï¼Œç»Ÿè®¡ä¸ŠæŠ¥ |
| **SeekTask** | `PlaybackController` | Start() â†’ Stop() | å¼‚æ­¥ Seek å¤„ç† |


#### 2. **PlayerStateManager çŠ¶æ€åŒæ­¥**

```cpp
// çº¿ç¨‹å®‰å…¨çš„çŠ¶æ€æŸ¥è¯¢
bool should_stop = state_manager_->ShouldStop();

// æš‚åœæ—¶ç­‰å¾…æ¢å¤
if (state_manager_->ShouldPause()) {
  state_manager_->WaitForResume();  // é˜»å¡ç›´åˆ° Resume()
}
```

è¯¦è§ [çŠ¶æ€ç®¡ç†ç³»ç»Ÿ](state_management.md)

#### 3. **AVSyncController æ—¶é’ŸåŒæ­¥**

```cpp
// AudioCallback æ›´æ–°ä¸»æ—¶é’Ÿ
av_sync_controller_->UpdateAudioClock(audio_pts);

// VideoPlayer æŸ¥è¯¢ä¸»æ—¶é’Ÿ
double master_clock = av_sync_controller_->GetMasterClock();
double delay = video_pts - master_clock;
```

---

## ğŸ¨ å…³é”®æŠ€æœ¯äº®ç‚¹

### 1. **é›¶æ‹·è´ç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“**

**é—®é¢˜**: ä¼ ç»Ÿè½¯ä»¶è§£ç  + CPU æ‹·è´è€—è´¹å¤§é‡æ€§èƒ½

**è§£å†³æ–¹æ¡ˆ**: ç¡¬ä»¶è§£ç ä¸ç¡¬ä»¶æ¸²æŸ“å…±äº« D3D11 è®¾å¤‡

```cpp
// 1. åˆ›å»ºå…±äº«çš„ D3D11 è®¾å¤‡
auto hw_context = std::make_unique<HWDecoderContext>();
hw_context->Initialize(HWDecoderType::kD3D11VA, codec_id, width, height);

// 2. VideoDecoder ä½¿ç”¨ç¡¬ä»¶è§£ç 
video_decoder_->Open(codec_params, nullptr, hw_context.get());

// 3. D3D11Renderer ç›´æ¥è®¿é—®ç¡¬ä»¶å¸§çš„çº¹ç†
ID3D11Texture2D* texture = hw_context->GetD3D11Texture(frame);
device_context->CopyResource(render_texture, texture);  // GPU å†…éƒ¨æ‹·è´
```

**æ€§èƒ½æå‡**:
- CPU å ç”¨é™ä½ 30-50%
- 4K è§†é¢‘æµç•…æ’­æ”¾
- é™ä½åŠŸè€—

### 2. **éŸ³é¢‘é¢„é‡é‡‡æ ·æ¶æ„**

**é—®é¢˜**: åœ¨éŸ³é¢‘å›è°ƒä¸­é‡é‡‡æ ·ä¼šé˜»å¡å®æ—¶çº¿ç¨‹

**è§£å†³æ–¹æ¡ˆ**: åœ¨è§£ç çº¿ç¨‹å®Œæˆé‡é‡‡æ ·

```cpp
// AudioDecodeTask (è§£ç çº¿ç¨‹)
auto frame = audio_decoder_->ReceiveFrame();
auto resampled = audio_resampler_->Resample(frame);  // â† åœ¨è¿™é‡Œé‡é‡‡æ ·
audio_player_->PushFrame(std::move(resampled));

// FillAudioBuffer (éŸ³é¢‘å›è°ƒ)
std::memcpy(stream, frame.data, len);  // â† ä»…æ‹·è´ï¼Œä¸åšä»»ä½•å¤„ç†
```

**ä¼˜åŠ¿**:
- éŸ³é¢‘å›è°ƒå»¶è¿Ÿé™ä½ 90%
- é¿å… Underrun (éŸ³é¢‘æ–­ç»­)
- SIMD ä¼˜åŒ–æœ‰å……è¶³æ—¶é—´

### 3. **æ¸²æŸ“è·¯å¾„æ™ºèƒ½é€‰æ‹©**

**é—®é¢˜**: ä¸åŒå¹³å°ã€ä¸åŒç¡¬ä»¶æ”¯æŒçš„åŠ é€Ÿæ–¹å¼ä¸åŒ

**è§£å†³æ–¹æ¡ˆ**: `RenderPathSelector` è‡ªåŠ¨æ£€æµ‹å¹¶é™çº§

```cpp
auto selection = RenderPathSelector::Select(codec_id, width, height);

// é€‰æ‹©é€»è¾‘:
// Windows: D3D11VA â†’ DXVA2 â†’ SDL2 è½¯ä»¶æ¸²æŸ“
// Linux:   VA-API â†’ SDL2 è½¯ä»¶æ¸²æŸ“
// macOS:   VideoToolbox â†’ SDL2 è½¯ä»¶æ¸²æŸ“
```

**å…³é”®ç‰¹æ€§**:
- é…ç½®é©±åŠ¨ï¼ˆå¯é€šè¿‡é…ç½®æ–‡ä»¶å¼ºåˆ¶è½¯ä»¶æ¸²æŸ“ï¼‰
- è‡ªåŠ¨é™çº§ï¼ˆç¡¬ä»¶å¤±è´¥æ—¶å›é€€ï¼‰
- é›¶æ‹·è´éªŒè¯ï¼ˆæ£€æµ‹æ˜¯å¦çœŸæ­£å®ç°é›¶æ‹·è´ï¼‰

### 4. **ç»Ÿä¸€çš„é”™è¯¯å¤„ç† Result<T>**

**é—®é¢˜**: ä¼ ç»Ÿ C++ é”™è¯¯å¤„ç†æ··ä¹±ï¼ˆè¿”å›å€¼ã€å¼‚å¸¸ã€é”™è¯¯ç ï¼‰

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ `Result<T>` ç±»å‹å®‰å…¨çš„é”™è¯¯ä¼ æ’­

```cpp
// é“¾å¼é”™è¯¯å¤„ç†
return demuxer_->Open(url)
    .AndThen([this]() { return InitializeVideoRenderingPipeline(); })
    .AndThen([this]() { return InitializeAudioDecoder(); })
    .MapErr([this](ErrorCode code) {
      CleanupResources();  // è‡ªåŠ¨æ¸…ç†
      return code;
    });
```

**ä¼˜åŠ¿**:
- ç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æœŸæ£€æŸ¥
- å¼ºåˆ¶é”™è¯¯å¤„ç†
- è‡ªåŠ¨èµ„æºæ¸…ç†ï¼ˆRAIIï¼‰

### 5. **å¼‚æ­¥ Seek æœºåˆ¶**

**é—®é¢˜**: åŒæ­¥ Seek ä¼šé˜»å¡ UI çº¿ç¨‹

**è§£å†³æ–¹æ¡ˆ**: ä¸“ç”¨ Seek çº¿ç¨‹ + è¯·æ±‚é˜Ÿåˆ—

```cpp
// SeekAsync ç«‹å³è¿”å›
void PlaybackController::SeekAsync(int64_t timestamp_ms, bool backward) {
  seek_request_queue_.Push(SeekRequest{timestamp_ms, backward, current_state});
}

// SeekTask åœ¨åå°å¤„ç†
void PlaybackController::SeekTask() {
  while (!should_stop) {
    auto request = seek_request_queue_.Pop();
    ExecuteSeek(request);  // æ‰§è¡Œ Seekï¼ˆå¯èƒ½è€—æ—¶ï¼‰
  }
}
```

**ä¼˜åŠ¿**:
- UI æ°¸ä¸å¡é¡¿
- æ”¯æŒ Seek è¯·æ±‚é˜Ÿåˆ—ï¼ˆåˆå¹¶è¿ç»­ Seekï¼‰
- çŠ¶æ€æ¢å¤ï¼ˆSeek åè‡ªåŠ¨æ¢å¤ Playing/Pausedï¼‰

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

æ·±å…¥äº†è§£å„ä¸ªæ¨¡å—çš„å®ç°ç»†èŠ‚ï¼š

### æ ¸å¿ƒæ¶æ„
- [æ ¸å¿ƒç»„ä»¶è¯¦è§£](core_components.md) - ZenPlayerã€PlaybackController ç­‰æ ¸å¿ƒç±»çš„è¯¦ç»†è®¾è®¡
- [çŠ¶æ€ç®¡ç†ç³»ç»Ÿ](state_management.md) - PlayerStateManager çš„çŠ¶æ€æœºè®¾è®¡ä¸å®ç°

### éŸ³è§†é¢‘åŒæ­¥
- [éŸ³è§†é¢‘åŒæ­¥åŸç†ä¸å®ç°](av_sync_design.md) - åŒæ­¥ç®—æ³•ã€æ—¶é’Ÿç®¡ç†ã€ä¸¢å¸§ç­–ç•¥

### æ¸²æŸ“ä¸è§£ç 
- [æ¸²æŸ“è·¯å¾„é€‰æ‹©å™¨è®¾è®¡](render_path_selector.md) - æ™ºèƒ½é€‰æ‹©ç¡¬ä»¶åŠ é€Ÿæ–¹æ¡ˆ
- [é›¶æ‹·è´æ¸²æŸ“è¯¦è§£](zero_copy_rendering.md) - ç¡¬ä»¶è§£ç ä¸æ¸²æŸ“çš„ååŒ
- [è§£ç å™¨è®¾è®¡](decoder_design.md) - VideoDecoderã€AudioDecoder å®ç°

### çº¿ç¨‹ä¸åŒæ­¥
- [çº¿ç¨‹æ¨¡å‹è¯¦è§£](threading_model.md) - 5 ä¸ªæ ¸å¿ƒçº¿ç¨‹çš„è¯¦ç»†è¯´æ˜
- [Seek ä¸“ç”¨çº¿ç¨‹](seek_thread.md) - å¼‚æ­¥ Seek å®ç°

### é…ç½®ä¸æ—¥å¿—
- [å…¨å±€é…ç½®ç³»ç»Ÿ](global_config.md) - GlobalConfig é…ç½®ç®¡ç†
- [æ—¥å¿—ç³»ç»Ÿæ¶æ„](logging_system.md) - LogManager ä¸ spdlog é›†æˆ

### å…¶ä»–ç»„ä»¶
- [ResultTè®¾è®¡](result_design.md)
- [BlockingQueueè®¾è®¡](blocking_queue_design.md)
- [Timerè®¾è®¡](timer_design.md)

---

## ğŸ“ æ€»ç»“

ZenPlay çš„æ¶æ„è®¾è®¡ä½“ç°äº†ä»¥ä¸‹æ ¸å¿ƒæ€æƒ³ï¼š

1. **æ¸…æ™°çš„åˆ†å±‚**: äº”å±‚æ¶æ„ç¡®ä¿èŒè´£åˆ†ç¦»å’Œä¾èµ–å•å‘
2. **å¯¹ç§°çš„è®¾è®¡**: éŸ³è§†é¢‘æ’­æ”¾å™¨åœ°ä½å¹³ç­‰ï¼Œä¾¿äºç†è§£å’Œç»´æŠ¤
3. **ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†**: é¿å…çŠ¶æ€ä¸ä¸€è‡´çš„å¸¸è§é—®é¢˜
4. **ç°ä»£åŒ–çš„ C++**: å……åˆ†åˆ©ç”¨ C++17 ç‰¹æ€§æå‡ä»£ç è´¨é‡
5. **æ€§èƒ½ä¼˜åŒ–**: é›¶æ‹·è´ã€é¢„é‡é‡‡æ ·ã€ç¡¬ä»¶åŠ é€Ÿç­‰å¤šé¡¹ä¼˜åŒ–
